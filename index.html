<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link rel="stylesheet" href="./libs/fhl.css"/>
<script src="./libs/jquery-1.10.2.js"></script>
<script src="./libs/xml2json.min.js"></script>
<script>


$(function(){
  //fhlTopMenu.init(pageState);
  //fhlTopMenu.render(pageState);
  fhlToolbar.init(pageState);
  fhlLecture.init(pageState,$('#fhlLecture'));
  fhlLeftBottomWindow.init(pageState,$('#fhlLeftBottomWindow'));
  fhlInfo.init(pageState);  
});

var urlJSON="https://bkbible.fhl.net/json/";

var pageState={
    //Input Parameters
    //For qb.php
    engs:"Gen",
    chineses:"創",
    chap:1,
    sec:1,
    version:["unv"],    
    strong:1,
    gb:0,
    //For sc.php
    book:3,
    //For sd.php
    N:0,
    k:"",    
    //Return Values
    cname:["和合本"],
    //For popups
    realTimePopUp:1,
    //For fhlInfoContent
    titleId:"fhlInfoComment",
    //For fhlLeftBottomWindow
    leftBtmWinShow:false,    
};

var book=new Array( "創","出","利","民","申","書","士","得","撒上","撒下","王上","王下",
                    "代上","代下","拉","尼","斯","伯","詩","箴","傳","歌","賽","耶",
                    "哀","結","但","何","珥","摩","俄","拿","彌","鴻","哈","番","該","亞","瑪",
                    "太","可","路","約","徒","羅","林前","林後","加","弗","腓","西",
                    "帖前","帖後","提前","提後","多","門","來","雅",
                    "彼前","彼後","約一","約二","約三","猶","啟");

var bookFullName=new Array( "創世記","出埃及記","利未記","民數記","申命記","約書亞記","士師記",
                            "路得記","撒母耳記上","撒母耳記下","列王紀上","列王紀下",
                            "歷代志上","歷代志下","以斯拉記","尼希米記","以斯帖記","約伯記",
                            "詩篇","箴言","傳道書","雅歌","以賽亞書","耶利米書",
                            "耶利米哀歌","以西結書","但以理書","何西阿書","約珥書","阿摩司書",
                            "俄巴底亞書","約拿書","彌迦書","那鴻書","哈巴谷書",
                            "西番雅書","哈該書","撒迦利亞書","瑪拉基書",
                            "馬太福音","馬可福音","路加福音","約翰福音","使徒行傳","羅馬書",
                            "哥林多前書","哥林多後書","加拉太書","以弗所書","腓立比書","歌羅西書",
                            "帖撒羅尼迦前書","帖撒羅尼迦後書","提摩太前書","提摩太後書",
                            "提多書","腓利門書","希伯來書","雅各書",
                            "彼得前書","彼得後書","約翰壹書","約翰貳書","約翰參書","猶大書","啟示錄");    
var bookChapters=new Array( 50,40,27,36,34,24,21,4,31,24,22,25,
                            29,36,10,13,10,42,150,31,12,8,66,52,
                            5,48,12,14,3,9,1,4,7,3,3,3,2,14,4,
                            28,16,24,21,28,16,16,13,6,6,4,4,
                            5,3,6,4,3,1,13,5,
                            5,3,5,1,1,1,22                            
                            );
var bookEng=new Array("Gen","Ex","Lev","Num","Deut","Josh","Judg","Ruth","1+Sam","2+Sam",
                "1+Kin","2+Kin","1+Chr","2+Chr","Ezra","Neh","Esth","Job","Ps","Prov",
                "Eccl","Song","Is","Jer","Lam","Ezek","Dan","Hos","Joel","Amos","Obad",
                "Jon","Mic","Nah","Hab","Zeph","Hag","Zech","Mal",
                "Matt","Mark","Luke","John","Acts","Rom","1+Cor","2+Cor","Gal","Eph",
                "Phil","Col","1+Thess","2+Thess","1+Tim","2+Tim","Titus","Philem",
                "Heb","James","1+Pet","2+Pet","1+John","2+John","3+John","Jude","Rev");    

function getAjaxUrl(func,ps,idx){
  var paramArr=new Array("engs","chineses","chap","sec","version",
                          "strong","gb","book","N","k");
  var urlParams={
    sc:[0,2,3,6,7],
    qb:[1,2,4,5,6],
    qp:[0,2,3,6],
    sd:[6,8,9]
  };  
  var getFullAjaxUrl=function(func,ps,idx){
    var ret=urlJSON+func+".php?";
    for(var i=0;i<urlParams[func].length;i++){
      if(paramArr[urlParams[func][i]]=="version"){
        ret+=paramArr[urlParams[func][i]];
        ret+="=";
        ret+=encodeURIComponent(ps[paramArr[urlParams[func][i]]][idx]);
        ret+="&";
      }else{
        ret+=paramArr[urlParams[func][i]];
        ret+="=";
        ret+=encodeURIComponent(ps[paramArr[urlParams[func][i]]]);
        ret+="&";        
      }
    };
    
    ret=ret.substring(0,ret.length-1);
    //console.log(ret);
    return ret;
  }
  return getFullAjaxUrl(func,ps,idx);
}

function getBookFunc(func,bookName){
  var i;
  for(i=0;i<book.length;i++)
    if(book[i]==bookName)
      break;
  var ret;
  switch(func){
    case "index":
      ret=i;
      break;
    case "bookFullName":
      ret=bookFullName[i];
      break;
    case "bookChapters":
      ret=bookChapters[i];
      break;
    case "bookEng":
      ret=bookEng[i];
      break;
    default:
      ret="failed";
      break;
  }
  return ret;
}

/***** Start of fhlToolbar *****/
var fhlToolbar={
  init:function(ps){
    bookSelect.init(ps,$('#bookSelect'));        
    versionSelect.init(ps,$('#versionSelect'));
    versionSelect.registerEvents(ps);
    snSelect.init(ps,$('#snSelect'));
    snSelect.registerEvents(ps);
    gbSelect.init(ps,$('#gbSelect'));
    gbSelect.registerEvents(ps);  
    realTimePopUpSelect.init(ps,$('#realTimePopUpSelect'));
    realTimePopUpSelect.registerEvents(ps);
  }
};

var bookSelect={
  init:function(ps,dom){    
    this.dom=dom;
    this.render(ps,this.dom);
    //position of Popup
    var offset=this.dom.offset();
    offset.top+=this.dom.height();
    bookSelectPopUp.init(ps,$('#bookSelectPopUp'),offset);
    bookSelectPopUp.registerEvents(ps);    
  },
  registerEvents:function(ps){
    var that=this;
    $('.chapSelect').click(function(){
      versionSelectPopUp.hide();
      bookSelectPopUp.show();      
    });
    $('.chapBack').click(function(){
      versionSelectPopUp.hide();
      var idx=getBookFunc("index",ps.chineses);
      if(ps.chap==1){
        ps.chineses=book[idx-1];
        ps.engs=bookEng[idx-1];
        ps.chap=bookChapters[idx-1];
      }else{
        ps.chap--;        
      }
      that.render(ps,that.dom);
      fhlLecture.render(ps,fhlLecture.dom);
      fhlInfo.render(ps);
      bookSelectPopUp.hide();      
    });
    $('.chapNext').click(function(){      
      versionSelectPopUp.hide();
      var idx=getBookFunc("index",ps.chineses);
      if(ps.chap==bookChapters[idx]){//if last chapter
        ps.chineses=book[idx+1];//book+1
        ps.engs=bookEng[idx+1];
        ps.chap=1;
      }else{
        ps.chap++;
      }
      that.render(ps,that.dom);
      fhlLecture.render(ps,fhlLecture.dom);
      fhlInfo.render(ps);
      bookSelectPopUp.hide();
    });
  },
  render:function(ps,dom){
    var bookName=getBookFunc("bookFullName",ps.chineses);
    if(bookName!="failed"){
      var html="";
      if(ps.chineses==book[0]&&ps.chap==1){
        html+="";
      }else{
        html+="<span class='chapBack'>&#x25C0</span>";
      }      
      html+="<span class='chapSelect'>"+bookName;
      html+="&nbsp&nbsp"+ps.chap+"</span>";
      if(ps.chineses==book[65]&&ps.chap==22){
        html+="";
      }else{
        html+="<span class='chapNext'>&#x25B6</span>";
      }            
      dom.html(html);
      this.registerEvents(ps);
    }
  }
};

var bookSelectPopUp={
  init:function(ps,dom,offset){
    this.dom=dom;
    this.dom.offset(offset);
    bookSelectName.init(ps,$('#bookSelectName'));    
    bookSelectName.registerEvents(ps);
    this.dom.hide();
  },
  registerEvents:function(ps){
    this.dom.mouseleave(function(){
      $(this).hide();
    });
  },  
  show:function(){
    this.dom.show();
  },
  hide:function(){
    this.dom.hide();
  }
};

var bookSelectName={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
    var that=this.dom;
    this.dom.find('li').click(function(){
      var idx=getBookFunc("index",$(this).attr('chineses'));
      var offset=that.offset();
      offset.left+=that.width();
      bookSelectChapter.init(ps,$('#bookSelectChapter'),idx,offset);
      bookSelectChapter.registerEvents(ps);
      that.find('li').removeClass('selected');
      $(this).addClass('selected');
    });
  },
  render:function(ps,dom){
    var html="<ul>";
    for(var i=0;i<bookFullName.length;i++)
      html+="<li>"+bookFullName[i]+"</li>";
    //Add 12 null items to do column count
    for(var i=0;i<11;i++)
      html+="<li>&nbsp</li>";
    html+="</ul>";    
    dom.html(html);
    for(var i=0;i<bookFullName.length;i++){
      dom.find('li:eq('+i+')').attr('chineses',book[i]);
    }
  }
};

var bookSelectChapter={
  init:function(ps,dom,idx,offset){
    this.dom=dom;
    this.idx=idx;
    this.dom.offset(offset);
    this.render(ps,this.dom,this.idx);
  },
  registerEvents:function(ps){
    var that=this;
    this.dom.find('li').click(function(){
      ps.chineses=book[that.idx];
      ps.engs=bookEng[that.idx];
      ps.chap=parseInt($(this).attr('chap'));
      ps.sec=1;
      bookSelect.render(ps,bookSelect.dom);
      fhlLecture.render(ps,fhlLecture.dom);
      fhlInfo.render(ps);
      bookSelectPopUp.hide();
    });
  },
  render:function(ps,dom,idx){
    var numOfChapters=bookChapters[idx];
    var html="<ul>";
    for(var i=1;i<=numOfChapters;i++){
      html+="<li>"+i+"</li>";
    }
    dom.html(html);
    for(var i=0;i<numOfChapters;i++){
      dom.find('li:eq('+i+')').attr('chap',i+1);
    }    
  }
};


var versionSelect={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
    //position of Popup
    var offset=this.dom.offset();
    offset.top+=this.dom.height();
    versionSelectPopUp.init(ps,$('#versionSelectPopUp'),offset);     
  },
  registerEvents:function(ps){
    this.dom.click(function(){
      bookSelectPopUp.hide();  
      versionSelectPopUp.show();
    });
  },
  render:function(ps,dom){
    dom.html("譯本設定");
  }
};
var versionSelectPopUp={
  init:function(ps,dom,offset){
    this.dom=dom;
    this.dom.offset(offset);
    var that=this;    
    var ajaxUrl=urlJSON+"abv.php";
    $.ajax({
      url:ajaxUrl
    }).done(function(d,s,j){
      if(j){
        var jsonObj=JSON.parse(j.responseText);
        that.data=jsonObj;
      }    
      that.render(ps,dom,that.data);  
    });        
    this.dom.hide();
  },
  registerEvents:function(ps){
    var that=this;
    this.dom.mouseleave(function(){
      $(this).hide();
    });
    this.dom.find('li').click(function(){
      $(this).toggleClass('selected');
      if($(this).hasClass('selected')){
        ps.version.push($(this).attr('book'));
        ps.cname.push($(this).attr('cname'));
      }else{
        var idx=ps.version.indexOf($(this).attr('book'));
        ps.version.splice(idx,1);
        ps.cname.splice(idx,1);
      }
      //Set Default version?      
      if(ps.version.length==0){
        var o=that.dom.find('li:eq(0)');
        ps.version.push(o.attr('book'));
        ps.cname.push(o.attr('cname'));
      }
      that.render(ps,that.dom,that.data);
      fhlLecture.render(ps,fhlLecture.dom);
    });
  },  
  render:function(ps,dom,data){
    var that=this;
    var html="<ul>";
    for(var i=0;i<data.record_count;i++){
      var o=data.record[i];
      html+="<li>"+o.cname+"</li>";
    }
    html+="</ul>";
    dom.html(html);
    for(var i=0;i<data.record_count;i++){
      var o=data.record[i];
      dom.find('li:eq('+i+')').attr(o);
    }        
    dom.find('li').removeClass('selected');
    for(var i=0;i<ps.version.length;i++){
      var v=ps.version[i];
      var li=dom.find('li[book="'+v+'"]');
      if(li!=null){
        li.each(function(){
          $(this).addClass('selected');
          var html=$(this).html();
          html+="&#x2713";
          $(this).html(html);
        });
      }
    }
    that.registerEvents(ps);    
  },
  show:function(){
    this.dom.show();
  },
  hide:function(){
    this.dom.hide();
  }
};

var snSelect={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
    $('.snBtn').click(function(){
      ps.strong=$(this).index();
      $('.snBtn').removeClass('selected');
      $('.snBtn').eq(ps.strong).addClass('selected');
      fhlLecture.render(ps,fhlLecture.dom);
    });
  },
  render:function(ps,dom){
    var html="SN位置";
    html+="<span class='snBtn menuBtn'>無</span>";
    html+="<span class='snBtn menuBtn'>後面</span>";
    dom.html(html);
    $('.snBtn').eq(ps.strong).addClass('selected');
  }
};
var gbSelect={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
    $('.gbBtn').click(function(){
      ps.gb=$(this).index();
      $('.gbBtn').removeClass('selected');
      $('.gbBtn').eq(ps.gb).addClass('selected');
      fhlLecture.render(ps,fhlLecture.dom);
    });
  },
  render:function(ps,dom){
    var html="";
    html+="<span class='gbBtn menuBtn'>繁</span>";
    html+="<span class='gbBtn menuBtn'>簡</span>";
    dom.html(html);
    $('.gbBtn').eq(ps.gb).addClass('selected');
  }
};
var realTimePopUpSelect={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
    $('.rtBtn').click(function(){
      ps.realTimePopUp=$(this).index();
      $('.rtBtn').removeClass('selected');
      $('.rtBtn').eq(ps.realTimePopUp).addClass('selected');
      fhlLecture.render(ps,fhlLecture.dom);
    });
  },
  render:function(ps,dom){
    var html="即時顯示";
    html+="<span class='rtBtn menuBtn'>關</span>";
    html+="<span class='rtBtn menuBtn'>開</span>";
    dom.html(html);
    $('.rtBtn').eq(ps.realTimePopUp).addClass('selected');
  }
};

/***** End of fhlToolbar *****/

/***** Start of fhlLecture *****/
function setCSS(col,ps){
  var totalWidth=80;  
  $('.lecContent').css('width',(totalWidth/col)+"%");
  $('.lecVersion').css('width',(totalWidth/col)+"%");
}

function getBibleText(col,ps,cbk,defCbk){
  var sem=col;
  //console.log("enter getBibleText");
  for(var i=0;i<col;i++){
    //console.log("launch ajax"+i);
    var ajaxUrl=getAjaxUrl("qb",ps,i);    
    $.ajax({
      url:ajaxUrl
    }).done(function(d,s,j){
      if(j){
        //console.log(j.responseText);
        var jsonObj=JSON.parse(j.responseText);
        cbk(jsonObj);
        sem--;
      }
    });
  }  
  var def=setInterval(function(){
    if(sem==0){
      defCbk();
      clearInterval(def);
    }
  },100);
}

function checkOldNew(ps){
//0 - Old 
//1 - New
  return (book.indexOf(ps.chineses)>=39)?0:1;  
}

function parseBibleText(text,ps,isOld){
  var ret;
  checkOldNew(ps);
  switch(ps.strong){
    case 0:
      ret=text;
      break;
    case 1:
      //console.log(text);
      text=text.replace(/[{}]/g,"");
      text=text.replace(/>/g,"</span>");
      text=text.replace(/<W[a-zA-Z]*/g,"<span class='sn' N="+isOld+">");
      //console.log(text);
      ret=text;
    default:
      ret=text;
      break;
  }
  return ret;

}

var fhlLecture={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,dom);
  },
  registerEvents:function(ps){
    var that=this.dom;
    that.find('.lec').click(function(){
      ps.sec=parseInt($(this).attr('sec'));
      $(that).find('.lec').removeClass('selected');
      $(this).addClass('selected');
      fhlInfo.render(ps);
    });
    if(ps.realTimePopUp==1){
      $('.sn').mouseenter(function(){
        var offset=$(this).offset();
        offset.top+=$(this).height()+10;
        ps.N=$(this).attr('N');
        ps.k=$(this).html();
        parsingPopUp.render(ps,parsingPopUp.dom,offset);
      });
    }else{
      $('.sn').click(function(){
        var offset=$(this).offset();
        offset.top+=$(this).height()+10;
        ps.N=$(this).attr('N');
        ps.k=$(this).html();
        parsingPopUp.render(ps,parsingPopUp.dom,offset);
      });      
    }
    /*$('.sn').mouseleave(function(){
      parsingPopUp.dom.hide();
    });*/
  },
  render:function(ps,dom){
    var that=this;
    var htmlTitle="<div class=lecTitle></div>";
    var htmlContent="";
    var col=ps.version.length;
    var rspArr=new Array();
    var idx=0;
    getBibleText(col,ps,function(o){
        rspArr.push(o);
    },function(){                
      var isOld=checkOldNew(ps);
      for(var i=0;i<rspArr.length;i++){
        var o=rspArr[i];
        htmlTitle+="<div class=lecContent>"+o.v_name+"</div>";
      }
      for(var i=0;i<rspArr[0].record_count;i++){
        var r=rspArr[0].record[i];
        htmlContent+="<div class=lec>";
        htmlContent+="<div class=lecTitle>"+r.chap+":"+r.sec+"</div>";
        for(j=0;j<rspArr.length;j++){
          var r=rspArr[j].record[i];          
          var bibleText=parseBibleText(r.bible_text,ps,isOld);
          htmlContent+="<div class=lecContent>"+bibleText+"</div>";
        }
        htmlContent+="</div>";        
      }
      var html=htmlTitle+htmlContent;
      dom.html(html);
      for(var i=0;i<rspArr[0].record_count;i++){
        var r=rspArr[0].record[i];
        dom.find('.lec:eq('+i+')').attr('chap',r.chap);
        dom.find('.lec:eq('+i+')').attr('sec',r.sec);
      }
      setCSS(col,ps);
      that.registerEvents(ps);
    });
  }
};

var fhlLeftBottomWindow={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,dom);
    this.registerEvents(ps);
  },
  registerEvents:function(ps){
    $('#fhlLeftBottomWindowTitle').click(function(){
      if(ps.leftBtmWinShow==true){
        var fhlLeftWindowH=$('#fhlLeftWindow').height();
        $('#fhlLeftBottomWindow').height(fhlLeftWindowH*0.1);//50%->5%
        var fhlLeftBottomWindowH=$('#fhlLeftBottomWindow').height();
        $('#fhlLeftBottomWindowTitle').height(fhlLeftBottomWindowH);
        $('#fhlLeftBottomWindowContent').height(0);
        $('#fhlLecture').height(fhlLeftWindowH*0.9);
        $('#fhlLeftBottomWindowContent').hide();
        ps.leftBtmWinShow=false;
      }else{
        var fhlLeftWindowH=$('#fhlLeftWindow').height();
        $('#fhlLeftBottomWindow').height(fhlLeftWindowH*0.5);//5%->50%
        var fhlLeftBottomWindowH=$('#fhlLeftBottomWindow').height();
        $('#fhlLeftBottomWindowTitle').height(fhlLeftBottomWindowH*0.1);
        $('#fhlLeftBottomWindowContent').height(fhlLeftBottomWindowH*0.9);        
        $('#fhlLecture').height(fhlLeftWindowH*0.5);
        $('#fhlLeftBottomWindowContent').show();
        ps.leftBtmWinShow=true;
      }
      var html=(ps.leftBtmWinShow==true)?"&#9661":"&#9651";
      html+="fhlLeftBottomWindowTitle";
      $('#fhlLeftBottomWindowTitle').html(html);
    });
  },
  render:function(ps,dom){
      var html=(ps.leftBtmWinShow==true)?"&#9661":"&#9651";
      html+="fhlLeftBottomWindowTitle";
      $('#fhlLeftBottomWindowTitle').html(html);
      if(ps.leftBtmWinShow==false){
        var fhlLeftWindowH=$('#fhlLeftWindow').height();
        $('#fhlLeftBottomWindow').height(fhlLeftWindowH*0.1);//50%->5%
        var fhlLeftBottomWindowH=$('#fhlLeftBottomWindow').height();
        $('#fhlLeftBottomWindowTitle').height(fhlLeftBottomWindowH);
        $('#fhlLeftBottomWindowContent').height(0);
        $('#fhlLecture').height(fhlLeftWindowH*0.9);
        $('#fhlLeftBottomWindowContent').hide();
      }else{
        var fhlLeftWindowH=$('#fhlLeftWindow').height();
        $('#fhlLeftBottomWindow').height(fhlLeftWindowH*0.5);//5%->50%
        var fhlLeftBottomWindowH=$('#fhlLeftBottomWindow').height();
        $('#fhlLeftBottomWindowTitle').height(fhlLeftBottomWindowH*0.1);
        $('#fhlLeftBottomWindowContent').height(fhlLeftBottomWindowH*0.9);        
        $('#fhlLecture').height(fhlLeftWindowH*0.5);
        $('#fhlLeftBottomWindowContent').show();
      }      
  }
};
/***** End of fhlLecture *****/

/***** Start of fhlInfo *****/
var fhlInfo={
  init:function(ps){
    fhlInfoTitle.init(ps,$('#fhlInfoTitle'));
    fhlInfoTitle.registerEvents(ps);
    fhlInfoContent.init(ps,$('#fhlInfoContent'));    
    fhlInfoContent.registerEvents(ps);
    parsingPopUp.init(ps,$('#parsingPopUp'));
  },
  render:function(ps){
    //fhlInfoTitle.render(ps,$('#fhlInfoTitle'));
    fhlInfoContent.render(ps,fhlInfoContent.dom);
  }
};

var fhlInfoTitle={
  init:function(ps,dom){
    this.dom=dom;
    this.title=[
              {"name":"原文","id":"fhlInfoParsing"},
              {"name":"注釋","id":"fhlInfoComment"},
              {"name":"講道","id":"fhlInfoPreach"},
              {"name":"串珠","id":"fhlInfoTsk"},
              {"name":"典藏","id":"fhlInfoOb"},
              {"name":"搜尋","id":"fhlInfoSearch"}
      ];    
    this.render(ps,this.dom);    
  },
  registerEvents:function(ps){
    //select all elements of info title
    var selectAll="";
    for(var i=0;i<this.title.length;i++){
      selectAll+="#"+this.title[i].id+",";      
    }    
    selectAll=selectAll.substring(0,selectAll.length-1);
    $(selectAll).click(function(){      
      $(selectAll).removeClass('selected');
      $(this).addClass('selected');
      ps.titleId=$(this).attr('id');
      fhlInfoContent.render(ps,fhlInfoContent.dom);
    });
  },  
  render:function(ps,dom){
    var html="<ul>";
    for(var i=0;i<this.title.length;i++){
      html+="<li>"+this.title[i].name+"</li>";
    }
    html+="</ul>";
    dom.html(html);
    for(var i=0;i<this.title.length;i++){
      dom.find('li:eq('+i+')').attr('id',this.title[i].id);
    }  
    $('#'+ps.titleId).addClass('selected');  
  }
};

var fhlInfoContent={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
    var that=this;
    switch(ps.titleId){
      case "fhlInfoParsing":
        if(ps.realTimePopUp==1){
          $('.parsing').mouseenter(function(){
            var offset=$(this).offset();
            offset.top+=$(this).height()+10;
            ps.N=$(this).attr('N');
            ps.k=$(this).attr('k');
            var par=decodeURIComponent($(this).attr('par'));
            parsingPopUp.render(ps,parsingPopUp.dom,offset,par);
          });
          /*$('.parsing').mouseleave(function(){
            parsingPopUp.dom.hide();
          });*/
          $('.parsingTable').mouseenter(function(){
            var offset=$(this).offset();
            offset.top+=$(this).height()+10;
            ps.N=$(this).attr('N');
            ps.k=$(this).attr('k');
            parsingPopUp.render(ps,parsingPopUp.dom,offset,"psn");
          });
          /*$('.parsingTable').mouseleave(function(){
            parsingPopUp.dom.hide();
          });*/
        }else{
          $('.parsing').click(function(){
            var offset=$(this).offset();
            offset.top+=$(this).height()+10;
            ps.N=$(this).attr('N');
            ps.k=$(this).attr('k');
            var par=decodeURIComponent($(this).attr('par'));
            parsingPopUp.render(ps,parsingPopUp.dom,offset,par);
          });
          $('.parsingTable').click(function(){
            var offset=$(this).offset();
            offset.top+=$(this).height()+10;
            ps.N=$(this).attr('N');
            ps.k=$(this).attr('k');
            parsingPopUp.render(ps,parsingPopUp.dom,offset,"psn");
          });                    
        }
        break;
      case "fhlInfoComment":
        $('.commentSecBack, .commentSecNext, .commentBackground').click(function(){
          var oldEngs=ps.engs;
          var oldChap=ps.chap;
          ps.engs=$(this).attr('engs');
          var idx=getBookFunc('indexByEngs',ps.engs);
          ps.chineses=book[idx];
          ps.chap=$(this).attr('chap');
          ps.sec=$(this).attr('sec');
          fhlInfo.render(ps);
        });
        break;
      default:
        break;
    }
  },
  render:function(ps,dom){
    var that=this;
    switch(ps.titleId){
      case "fhlInfoParsing":
        var html="";
        var ajaxUrl=getAjaxUrl("qp",ps);
        $.ajax({
          url:ajaxUrl
        }).done(function(d,s,j){
          if(j){                  
            var jsonObj=JSON.parse(j.responseText);
            var v_name=jsonObj.v_name;
            var version=jsonObj.version;
            var prev_chineses=jsonObj.prev.chineses;
            var prev_engs=jsonObj.prev.engs;
            var prev_chap=jsonObj.prev.chap;
            var prev_sec=jsonObj.prev.sec;
            var next_chineses=jsonObj.next.chineses;
            var next_engs=jsonObj.next.engs;
            var next_chap=jsonObj.next.chap;
            var next_sec=jsonObj.next.sec;
            var proc=jsonObj.proc;
            var div_name=ps.titleId;
            if (version=="cbol") proc=10;//原文直譯
            var orig_font;
            var head_str="";
            var body_str="";
            var clrstr="";
            var clrcnt=0;
            var N=jsonObj.N;
            if (N==0) orig_font="g1";
            else    orig_font="g2";
            var html=jsonObj.N+"</br>";
            for (var i=0;i<jsonObj.record.length;i++){
                var wid=jsonObj.record[i].wid;
                var word=jsonObj.record[i].word;
                var exp=jsonObj.record[i].exp;
                var id=jsonObj.record[i].id;
                var parallel="";
                var align_str="";
                if (wid==0)
                {
                    if (N==0)//NT
                    {
                        var wstr="";
                        var wd=word.split("+");
                        if (wd.length>0)
                        {
                            for (var ii=0;ii<wd.length;ii++)
                            {
                                if (ii%3==0)
                                    wstr=wstr+wd[ii];
                                else if (ii%3==1)
                                    wstr=wstr+"(韋："+wd[ii]+")";
                                else if (ii%3==2)
                                    wstr=wstr+"(聯："+wd[ii]+")";
                            }
                            word=wstr;
                        }
                    }
                    else if (N==1) //OT
                    {
                        var remark=jsonObj.record[i].remark;
                        var engs=jsonObj.record[i].engs;
                        if (remark.length>0)
                        {
                                parallel="平行經文："+remark;
                        }
                        align_str="align=\"right\" style=\"padding:0px 10px 0px 0px;\"";
                    }
                    var chineses=jsonObj.record[i].chineses;
                    var chinesef=jsonObj.record[i].chinesef;
                    var chap=jsonObj.record[i].chap;
                    var sec=jsonObj.record[i].sec;
                    var poverhead="",noverhead="";                    
                    if (prev_chineses!=chineses||prev_chap!=chap)
                        poverhead=";Gclick=false;Gsec="+prev_sec+";read_bible('"+chineses+"',"+prev_chap+");";
                    if (next_chineses!=chineses||next_chap!=chap)
                        noverhead=";Gclick=false;Gsec="+next_sec+";read_bible('"+chineses+"',"+next_chap+");";
                        head_str="<span style=\"font-size:150%;\"><a href=\"javascript:spar('"+prev_engs+"',"+prev_chap+","+prev_sec+",'"+div_name+"')"+
                        poverhead+"\">&lt;</a> <span class=\"psn\">"+
                        chinesef+"  "+chap+":"+sec
                        +"</span> <a href=\"javascript:spar('"+next_engs+"',"+next_chap+","+next_sec+",'"+div_name+"')"+
                        noverhead+"\">&gt;</a></span> "+parallel+"<br/>";
                   var nword=word.split("\n");
                   var nexp=exp.split("\n");                                      
                   if (N==1){//OT                                 
                      var wid=1;                   
                      for (var ii=0;ii<nword.length;ii++){                                                
                        var t=nword[nword.length-ii-1].split(" ");
                        //console.dir(t);                                                
                        head_str+="<div>";
                        for (var iii=0;iii<t.length;iii++){                          
                          //console.log(t[iii]);
                          if(t[iii].indexOf("-")==-1){
                            var sn=jsonObj.record[wid].sn;
                            var wform=jsonObj.record[wid].wform;
                            var orig=jsonObj.record[wid].orig;
                            var remark=jsonObj.record[wid].remark;
                            var exp1=jsonObj.record[wid].exp;
                            var par=encodeURIComponent(wform+'|'+orig+'|'+exp1+'|'+remark+'|');
                            head_str+="<span class=parsing N=1 k="+sn+" par="+par+">";
                            head_str+=t[iii]+"&nbsp</span>";
                            wid++;
                          }else{
                            var s=t[iii].split("-");
                            for(iiii=0;iiii<s.length;iiii++){
                              var sn=jsonObj.record[wid].sn;
                              var wform=jsonObj.record[wid].wform;
                              var orig=jsonObj.record[wid].orig;
                              var remark=jsonObj.record[wid].remark;
                              var exp1=jsonObj.record[wid].exp;
                              var par=encodeURIComponent(wform+'|'+orig+'|'+exp1+'|'+remark+'|');
                              head_str+="<span class=parsing N=1 k="+sn+" par="+par+">";
                              if(iiii==0)
                                head_str+=s[iiii]+"-</span>";
                              else
                                head_str+=s[iiii]+"&nbsp</span>";
                              wid++;
                            }                            
                          }
                        }
                        head_str+="</div>";
                        head_str+="<div>"+nexp[ii]+"</div>";                        
                      }
                   }
                   else if (N==0){
                      var wid=1;
                      for (var ii=0;ii<nword.length;ii++){
                        var t=nword[ii].split(" ");
                        head_str+="<div>";
                        for (var iii=0;iii<t.length;iii++,wid++){
                          var sn=jsonObj.record[wid].sn;
                          var pro=jsonObj.record[wid].pro;
                          var wform=jsonObj.record[wid].wform;
                          var orig=jsonObj.record[wid].orig;
                          var remark=jsonObj.record[wid].remark;
                          var exp1=jsonObj.record[wid].exp;
                          var par=encodeURIComponent(pro+'|'+wform+'|'+orig+'|'+exp1+'|'+remark+'|');
                          head_str+="<span class=parsing N=0 k="+sn+" par="+par+">";
                          head_str+=t[iii]+"&nbsp</span>";
                        }
                        head_str+="</div>";
                        head_str+="<div>"+nexp[ii]+"</div>";                        
                      }                          
                   }
             }
             else
            {
                if (N==0 && word=="+") {
                    clrcnt=(clrcnt+1)%3;
                    if (clrcnt==0) clrstr="";
                    else if (clrcnt==1) clrstr="#ffff99";
                    else if (clrcnt==2) clrstr="#ffcccc";
                    msg=skip1tag(msg,"record");
                    continue;
                } 
                var sn=jsonObj.record[i].sn;
                var pro=jsonObj.record[i].pro;
                var wform=jsonObj.record[i].wform;
                var orig=jsonObj.record[i].orig;
                var remark=jsonObj.record[i].remark;
                var pt=remark.indexOf("[#");
                var pt1=remark.indexOf("#]");
                while (N==1 && pt>=0 && pt1>pt)
                {
                    var nstr="";
                    var pstr=remark.substring(pt+2,pt1);
                    pstr=pstr.replace(/１/g,"1");
                    pstr=pstr.replace(/２/g,"2");
                    pstr=pstr.replace(/３/g,"3");
                    pstr=pstr.replace(/４/g,"4");
                    pstr=pstr.replace(/５/g,"5");
                    pstr=pstr.replace(/６/g,"6");
                    pstr=pstr.replace(/７/g,"7");
                    pstr=pstr.replace(/８/g,"8");
                    pstr=pstr.replace(/９/g,"9");
                    pstr=pstr.replace(/．/g,".");
                    subheb=pstr.split(",");
                    nstr="§";
                    for (si=0;si<subheb.length;si++)
                    {
                        subheb[si]=subheb[si].trim();
                        if (subheb[si].length==0) continue;
                        spt=subheb[si].split("-");
                        nstr=nstr+"<a href=\"/new/pimg/"+spt[0]+".png\" target=\"grammer\">"+subheb[si]+"</a> ";
                    }
                    remark=remark.substring(0,pt)+nstr+remark.substring(pt1+2);
                    pt=remark.indexOf("[#");
                    pt1=remark.indexOf("#]");
                }
                body_str=body_str+"<tr bgcolor=\""+clrstr+"\"><td class=\""+orig_font+"\">"+word+"</td><td class=\"g0\"><span class=\"parsingTable\" N="+N+" k="+sn+">"+sn+"</span></td><td class=\"g0\">";
                if (N==0)
                    body_str=body_str+pro+"</td><td class=\"g0\">";
                body_str=body_str+wform+"</td><td class=\""+orig_font+"\">"+orig+"</td><td class=\"g0\">"+exp+"</td><td class=\"g0\">"
                        +remark+"</td></tr>";
             }//else
            }//for I
             var ptg="";
             if (N==0)
                ptg="<td class=\"g0\">詞性</td>";
            dom.html("<div style=\"height:25%;overflow:auto;\">"+head_str+"</div><div style=\"height:70%;overflow:auto;\"><hr/><table border=\"1\">"+
     "<tr><td class=\"g0\">原文字</td><td class=\"g0\">SN</td>"+ptg+"<td class=\"g0\">字彙分析</td><td class=\"g0\">原型</td><td class=\"g0\">原型簡義</td><td class=\"g0\">備註</td>"+body_str+"</table></div>");
            that.registerEvents(ps);
          }//if j
        });
        //tjm      
        break;
      case "fhlInfoComment":
        var html="";
        var ajaxUrl=getAjaxUrl("sc",ps);
        //console.log(ajaxUrl);
        $.ajax({
          url:ajaxUrl
        }).done(function(d,s,j){
          if(j){                  
            function parseComment(t){                    
              t=t.replace(/\n/g,"</br>");
              t=t.replace(/ /g,"&nbsp");
              var pt,pt1;
              var tok;
              while(true){
                pt=t.indexOf("#");
                pt1=t.indexOf("|");
                if(pt<0||pt1<0||pt1<=pt)
                  break;
                tok=t.substring(pt+1,pt1);
                t=t.substring(0,pt)+'<a href="">'+tok+"</a>"+t.substring(pt1+1);
              }
              return t;
            }
            var jsonObj=JSON.parse(j.responseText);
            //console.log(j.responseText);
            
            //console.log(html);
            
            var prev_engs;
            var prev_chap;
            var prev_sec;
            var next_engs;
            var next_chap;
            var next_sec;
            var head_str="";

            if(jsonObj.hasOwnProperty('prev')){
                prev_engs=jsonObj.prev.engs;
                prev_chap=jsonObj.prev.chap;
                prev_sec=jsonObj.prev.sec;
                head_str+="<span class='commentSecBack' ";
                head_str+="engs="+prev_engs+" chap="+prev_chap+" sec="+prev_sec;
                head_str+=">&#x25C0</span>";
            } 
              
            head_str+=jsonObj.record[0].title;
              
            if(jsonObj.hasOwnProperty('next')){
                next_engs=jsonObj.next.engs;
                next_chap=jsonObj.next.chap;
                next_sec=jsonObj.next.sec;
                head_str+="<span class='commentSecNext' ";
                head_str+="engs="+next_engs+" chap="+next_chap+" sec="+next_sec;
                head_str+=">&#x25B6</span>";
            }
            
            if(ps.chap!=0&&ps.sec!=0){
                head_str+="&nbsp;&nbsp;<span class='commentBackground' ";
                head_str+="engs="+ps.engs+" chap="+0+" sec="+0;
                head_str+=">背景</span>";
            }
            
            head_str+="</br>";

            var html=jsonObj.record[0].com_text;
            html=parseComment(html);
            
            dom.html(head_str+html);
            that.registerEvents(ps);
          }
        });
        break;
      case "fhlInfoPreach":
        var html=ps.titleId;
        dom.html(html);      
        break;
      case "fhlInfoTsk":
        var html=ps.titleId;
        dom.html(html);      
        break;
      case "fhlInfoOb":
        var html=ps.titleId;
        dom.html(html);      
        break;
      case "fhlInfoSearch":
        var html=ps.titleId;
        dom.html(html);      
        break;                                        
    }
  }
};
var parsingPopUp={
  init:function(ps,dom){
    this.dom=dom;
    this.dom.hide();
  },
  registerEvents:function(ps){
    var that=this;
    this.dom.mouseleave(function(){
      that.dom.hide();
      that.dom.css({
        overflow:'hidden',
        height: 'auto'
      });
    });
    this.dom.mousedown(function(e){
      if(e.which==3){
        that.dom.unbind('mouseleave');
      }
    });
  },
  render:function(ps,dom,offset,par){
    var that=this;    
    if(par=="psn"){
      var ajaxUrl=getAjaxUrl('sd',ps);
      $.ajax({
        url:ajaxUrl
      }).done(function(d,s,j){      
        var jsonObj=JSON.parse(j.responseText);      
        var html=jsonObj.record[0].dic_text;
        html=html.replace(/\r\n/g,"</br>");
        dom.html(html);                  
        var lecTop=164;
        var lecTopOffset=120;
        var RightWinH=$('#fhlInfo').height();
        var domH=dom.height();
        console.log("top:"+offset.top+",domH:"+domH+",RightWinH:"+RightWinH);

        if(domH>RightWinH){
          //set css to auto scroll
        }else if(offset.top+domH>RightWinH){
          offset.top-=(offset.top>domH)?domH:offset.top;
          offset.left+=70;
        }    
        that.dom.show();
        dom.offset(offset);
        that.registerEvents(ps);
      });            
    }else if(par!=null){      
      var html=par;      
      dom.html(html);                  
      that.dom.show();
      dom.offset(offset);
      //that.dom.scrollTop(0);      
      that.registerEvents(ps);
    }else{
      var ajaxUrl=getAjaxUrl('sd',ps);
      $.ajax({
        url:ajaxUrl
      }).done(function(d,s,j){      
        var jsonObj=JSON.parse(j.responseText);      
        var html=jsonObj.record[0].dic_text;
        html=html.replace(/\r\n/g,"</br>");
        dom.html(html);                  
        var lecTop=164;
        var lecTopOffset=120;
        var leftWinH=$('#fhlLeftWindow').height();
        var lecH=$('#fhlLecture').height();
        var scrollY=$('#fhlLecture').scrollTop();
        var scrollH=$('#fhlLecture')[0].scrollHeight;
        var domH=dom.height();
        console.log("top:"+offset.top+",domH:"+domH+",leftWinH:"+leftWinH+",lecH:"+lecH);
        console.log("scrollH:"+scrollH+",scrollY:"+scrollY);        

        if(domH>leftWinH){
          //set css to auto scroll
        }else if(offset.top+domH>leftWinH){
          offset.top-=(offset.top>domH)?domH:offset.top;
          offset.left+=50;
        }
/*
        if((offset.top+domH+scrollY)>scrollH){

        }
        else if((offset.top+domH)>leftWinH){
          $('#fhlLecture').scrollTop(scrollY+offset.top-lecTop);
          offset.top-=offset.top-lecTop;
        }
*/
        that.dom.show();
        dom.offset(offset);
        that.registerEvents(ps);
      });
    }
  }
};
/***** End of fhlInfo *****/
</script>
</head>
<body>
<!-- Layer 1-->
<div id="fhlTopMenu">
	<img id="logoFHL" src="./images/logoTopMenuFHL.png"/>
</div>
<div id="fhlToolbar" class="toolbar">
  <div id="bookSelect"></div>
  <div id="versionSelect"></div>
  <div id="snSelect"></div>  
  <div id="gbSelect">gbSelect</div>  
  <div id="realTimePopUpSelect">realTimeShowPopUpSelect</div>
  <div id="searchTool">searchTool</div>
  <div id="fontSizeTool">fontSizeTool</div>
  <div id="mapTool">mapTool</div>
  <div id="imageTool">imageTool</div>  
</div>
<div id="fhlLeftWindow">
    <div id="fhlLecture"></div>
    <div id="fhlLeftBottomWindow">
      <div id="fhlLeftBottomWindowTitle"></div>
      <div id="fhlLeftBottomWindowContent">
        Content of fhlLeftBottomWindowContent
      </div>
    </div>
</div>
<div id="fhlInfo">
  <div id="fhlInfoTitle"></div>
  <div id="fhlInfoContent"></div>
</div>
<!-- Layer 2 windows that hide after mouse leave-->
<div id="bookSelectPopUp">
  <div id="bookSelectName"></div>
  <div id="bookSelectChapter"></div>
</div>
<div id="versionSelectPopUp">  
</div>
<div id="parsingPopUp"></div>
<!-- Layer 3 windows that exists after mouse leave-->
<div id="dictionaryPopUp"></div>
</body>
</html>