<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link rel="stylesheet" href="./libs/fhl.css"/>    
<script src="./libs/jquery-1.10.2.js"></script>
<script src="./libs/xml2json.min.js"></script>
<link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
<script src="./libs/jquery.hotkeys.js"></script>
<script src="bible_audio_api/audiobible_api.js"></script>
<script>

var pageState;
var currentSWVer="0.9";

function setPageState(ps){
  var isViewed=false;
  for(var i=0;i<ps.history.length;i++){
    var data=ps.history[i];
    if(ps.chineses==data.chineses&&ps.chap==data.chap)
      isViewed=true;
  }
  if(isViewed==false)
    ps.history.push({chineses:ps.chineses,chap:ps.chap});
  //console.dir(ps);
  localStorage.setItem("fhlPageState",JSON.stringify(pageState));  
}
function pageStateInit(){
    pageState={
      engs:"Gen",chineses:"創",chap:1,sec:1,version:["unv"],strong:0,
      gb:0,book:3,N:0,k:"",cname:["和合本"],realTimePopUp:0,titleId:"fhlInfoComment",
      history:[{chineses:"創",chap:1}],
      leftBtmWinShow:true,searchTitleMsg:"",audio:0,swVer:currentSWVer
    };
}

$(function(){
  //fhlTopMenu.init(pageState);
  //fhlTopMenu.render(pageState);
  //Check cache
  if(localStorage.getItem("fhlPageState")!=null){
    //console.log(localStorage.getItem("fhlPageState"));
    var tmp=JSON.parse(localStorage.getItem("fhlPageState"));
    if(tmp.swVer!=currentSWVer){
      pageStateInit();
      setPageState(pageState);       
    }else{
      pageState=tmp;
      setPageState(pageState);
    }
  }else{
    pageStateInit();
    setPageState(pageState); 
  }  
  fhlToolBar.init(pageState);
  fhlLeftWindow.init(pageState);
  fhlMidWindow.init(pageState);
  fhlInfo.init(pageState);  
  searchInit(pageState);
  shortcutReg();
});

var urlJSON="https://bkbible.fhl.net/json/";  
var chineseNumber=new Array( "零", "一", "二", "三", "四", "五", "六", "七", "八", "九", "十",
                            "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十",
                            "二十一", "二十二", "二十三", "二十四", "二十五", "二十六", "二十七", "二十八", "二十九", "三十",
                            "三十一", "三十二", "三十三", "三十四", "三十五", "三十六", "三十七", "三十八", "三十九", "四十",
                            "四十一", "四十二", "四十三", "四十四", "四十五", "四十六", "四十七", "四十八", "四十九", "五十",
                            "五十一", "五十二", "五十三", "五十四", "五十五", "五十六", "五十七", "五十八", "五十九", "六十",
                            "六十一", "六十二", "六十三", "六十四", "六十五", "六十六", "六十七", "六十八", "六十九", "七十",
                            "七十一", "七十二", "七十三", "七十四", "七十五", "七十六", "七十七", "七十八", "七十九", "八十",
                            "八十一", "八十二", "八十三", "八十四", "八十五", "八十六", "八十七", "八十八", "八十九", "九十",
                            "九十一", "九十二", "九十三", "九十四", "九十五", "九十六", "九十七", "九十八", "九十九", "一百",
                            "一百零一", "一百零二", "一百零三", "一百零四", "一百零五", "一百零六", "一百零七", "一百零八", "一百零九", "一百一十",
                            "一百一十一", "一百一十二", "一百一十三", "一百一十四", "一百一十五", "一百一十六", "一百一十七", "一百一十八", "一百一十九", "一百二十",
                            "一百二十一", "一百二十二", "一百二十三", "一百二十四", "一百二十五", "一百二十六", "一百二十七", "一百二十八", "一百二十九", "一百三十",
                            "一百三十一", "一百三十二", "一百三十三", "一百三十四", "一百三十五", "一百三十六", "一百三十七", "一百三十八", "一百三十九", "一百四十",
                            "一百四十一", "一百四十二", "一百四十三", "一百四十四", "一百四十五", "一百四十六", "一百四十七", "一百四十八", "一百四十九", "一百五十");

var book=new Array( "創","出","利","民","申","書","士","得","撒上","撒下","王上","王下",
                    "代上","代下","拉","尼","斯","伯","詩","箴","傳","歌","賽","耶",
                    "哀","結","但","何","珥","摩","俄","拿","彌","鴻","哈","番","該","亞","瑪",
                    "太","可","路","約","徒","羅","林前","林後","加","弗","腓","西",
                    "帖前","帖後","提前","提後","多","門","來","雅",
                    "彼前","彼後","約一","約二","約三","猶","啟");

var bookFullName=new Array( "創世記","出埃及記","利未記","民數記","申命記","約書亞記","士師記",
                            "路得記","撒母耳記上","撒母耳記下","列王紀上","列王紀下",
                            "歷代志上","歷代志下","以斯拉記","尼希米記","以斯帖記","約伯記",
                            "詩篇","箴言","傳道書","雅歌","以賽亞書","耶利米書",
                            "耶利米哀歌","以西結書","但以理書","何西阿書","約珥書","阿摩司書",
                            "俄巴底亞書","約拿書","彌迦書","那鴻書","哈巴谷書",
                            "西番雅書","哈該書","撒迦利亞書","瑪拉基書",
                            "馬太福音","馬可福音","路加福音","約翰福音","使徒行傳","羅馬書",
                            "哥林多前書","哥林多後書","加拉太書","以弗所書","腓立比書","歌羅西書",
                            "帖撒羅尼迦前書","帖撒羅尼迦後書","提摩太前書","提摩太後書",
                            "提多書","腓利門書","希伯來書","雅各書",
                            "彼得前書","彼得後書","約翰壹書","約翰貳書","約翰參書","猶大書","啟示錄");    
var bookChapters=new Array( 50,40,27,36,34,24,21,4,31,24,22,25,
                            29,36,10,13,10,42,150,31,12,8,66,52,
                            5,48,12,14,3,9,1,4,7,3,3,3,2,14,4,
                            28,16,24,21,28,16,16,13,6,6,4,4,
                            5,3,6,4,3,1,13,5,
                            5,3,5,1,1,1,22                            
                            );
var bookEng=new Array("Gen","Ex","Lev","Num","Deut","Josh","Judg","Ruth","1 Sam","2 Sam",
                "1 Kin","2 Kin","1 Chr","2 Chr","Ezra","Neh","Esth","Job","Ps","Prov",
                "Eccl","Song","Is","Jer","Lam","Ezek","Dan","Hos","Joel","Amos","Obad",
                "Jon","Mic","Nah","Hab","Zeph","Hag","Zech","Mal",
                "Matt","Mark","Luke","John","Acts","Rom","1 Cor","2 Cor","Gal","Eph",
                "Phil","Col","1 Thess","2 Thess","1 Tim","2 Tim","Titus","Philem",
                "Heb","James","1 Pet","2 Pet","1 John","2 John","3 John","Jude","Rev");
function getAjaxUrl(func,ps,idx){
  var paramArr=new Array("engs","chineses","chap","sec","version",
                          "strong","gb","book","N","k");
  var urlParams={
    sc:[0,2,3,6,7],
    qb:[1,2,4,5,6],
    qp:[0,2,3,6],
    sd:[6,8,9]
  };  
  var getFullAjaxUrl=function(func,ps,idx){
    var ret=urlJSON+func+".php?";
    for(var i=0;i<urlParams[func].length;i++){
      if(paramArr[urlParams[func][i]]=="version"){
        ret+=paramArr[urlParams[func][i]];
        ret+="=";
        ret+=encodeURIComponent(ps[paramArr[urlParams[func][i]]][idx]);
        ret+="&";
      }else{
        ret+=paramArr[urlParams[func][i]];
        ret+="=";
        ret+=encodeURIComponent(ps[paramArr[urlParams[func][i]]]);
        ret+="&";        
      }
    };
    
    ret=ret.substring(0,ret.length-1);
    //console.log(ret);
    return ret;
  }
  return getFullAjaxUrl(func,ps,idx);
}

function getBookFunc(func,bookName){
  var i;
  for(i=0;i<book.length;i++)
    if(book[i]==bookName)break;
  var ret;
  switch(func){
    case "index":
      ret=i;
      break;
    case "indexByEngs":
      for(i=0;i<bookEng.length;i++)
        if(bookEng[i]==bookName)break;
      ret=i;
      break;
    case "bookFullName":
      ret=bookFullName[i];
      break;
    case "bookChapters":
      ret=bookChapters[i];
      break;
    case "bookEng":
      ret=bookEng[i];
      break;
    default:
      ret="failed";
      break;
  }
  return ret;
}

function shortcutReg(){
    $(document).bind('keydown', 'ctrl+f', function(){$('[data-ic-class="search-trigger"]').trigger("click");});
    $(document).bind('keydown', 'esc', function(){
        $('#helpingPopUp').css({
            'visibility': 'hidden',
            'opacity': '0'
        });
    });
    
    /*in search input*/
    $('[data-ic-class="search-input"]').bind('keydown', 'esc', function(){
        $('[data-ic-class="search-input"]').val('');
        $('[data-ic-class="search-trigger"]').removeClass('active');
    });
    $('[data-ic-class="search-input"]').bind('keydown', 'return', function(){
        $('.searchBtn').trigger("click");
    });
}
    
/***** Start of fhlToolBar *****/
    
var bookSelectChapterAutoCloseTimeout;
var bookSelectAutoCloseTimeout;

var fhlToolBar={
    init:function(ps){
        //this.registerEvents();
        windowControl.init(ps,$('#windowControl'));
        windowControl.registerEvents(ps);
        help.init(ps,$('#help'));
        bookSelect.init(ps,$('#bookSelect'));
        searchTool.init(ps,$('#searchTool'));
        searchTool.registerEvents(ps);
    }
};
    
var windowControl={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
    this.registerEvents(ps);
    setTimeout(function(){ 
        $('#fhlMidBottomWindowControl').trigger("click");
        $('#fhlMidBottomWindowControl').css({'color': '#FFFFFF'});
    }, 500);
  },
  registerEvents:function(ps){
      $('#fhlLeftWindowControl').click(function(){
          if($('#fhlLeftWindow').css('left')=='12px'){
              $('#fhlLeftWindowControl').hover(function() {
                  $(this).css({'color': '#00A0FF'});
              }, function() {
                  $(this).css({'color': '#FFFFFF'});
              });
              var fhlLeftWindowWidth = $("#fhlLeftWindow").width();
              $("#fhlLeftWindow").animate({left: -fhlLeftWindowWidth-15 + 'px'});
              $("#fhlMidWindow").animate({left: '12px', width: $("#fhlMidWindow").width() + fhlLeftWindowWidth + 12 + 'px'});
          }
          else{
              $('#fhlLeftWindowControl').hover(function() {
                  $(this).css({'color': '#00A0FF'});
              }, function() {
                  $(this).css({'color': '#0050FF'});
              });
              var fhlLeftWindowWidth = $("#fhlLeftWindow").width();
              $("#fhlLeftWindow").animate({left: '12px'});
              $("#fhlMidWindow").animate({left: fhlLeftWindowWidth+12+12 + 'px', width: $("#fhlMidWindow").width() - fhlLeftWindowWidth -12 + 'px'});
          }
      });
      $('#fhlMidBottomWindowControl').click(function(){
          if($('#fhlMidBottomWindow').css('bottom')=='0px'){
              $('#fhlMidBottomWindowControl').hover(function() {
                  $(this).css({'color': '#00A0FF'});
              }, function() {
                  $(this).css({'color': '#FFFFFF'});
              });
              var fhlMidBottomWindowHeight = $("#fhlMidBottomWindow").height();
              $("#fhlMidBottomWindow").animate({top: $('#fhlMidWindow').height()+15+'px', bottom: -fhlMidBottomWindowHeight-15 + 'px'});
              $("#fhlLecture").animate({bottom: '0px', height: $("#fhlLecture").height() + fhlMidBottomWindowHeight+12 + 'px'});
          }
          else{
              $('#fhlMidBottomWindowControl').hover(function() {
                  $(this).css({'color': '#00A0FF'});
              }, function() {
                  $(this).css({'color': '#0050FF'});
              });
              var fhlMidBottomWindowHeight = $("#fhlMidBottomWindow").height();
              $("#fhlMidBottomWindow").animate({top: $('#fhlMidWindow').height()-fhlMidBottomWindowHeight+'px', bottom: '0px'});
              $("#fhlLecture").animate({bottom: fhlMidBottomWindowHeight + 'px', height: $("#fhlLecture").height() - fhlMidBottomWindowHeight - 12 + 'px'});
          }
      });
      $('#fhlInfoWindowControl').click(function(){
          if($('#fhlInfo').css('right')=='12px'){
              $('#fhlInfoWindowControl').hover(function() {
                  $(this).css({'color': '#00A0FF'});
              }, function() {
                  $(this).css({'color': '#FFFFFF'});
              });
              var fhlInfoWidth = $("#fhlInfo").width();
              $("#fhlInfo").animate({left: $(window).width() + 15 + 'px', right: -fhlInfoWidth-15 + 'px', width: fhlInfoWidth});
              $("#fhlMidWindow").animate({right: '12px', width: $("#fhlMidWindow").width() + fhlInfoWidth + 12 + 'px'});
          }
          else{
              $('#fhlInfoWindowControl').hover(function() {
                  $(this).css({'color': '#00A0FF'});
              }, function() {
                  $(this).css({'color': '#0050FF'});
              });
              var fhlInfoWidth = $("#fhlInfo").width();
              $("#fhlInfo").animate({left: $(window).width()-fhlInfoWidth-12 + 'px', right: '12px'});
              $("#fhlMidWindow").animate({right: fhlInfoWidth + 'px', width: $("#fhlMidWindow").width() - fhlInfoWidth - 12 + 'px'});
          }
      });
  },
  render:function(ps,dom){
    var html="<span id='fhlLeftWindowControl' style='top: -1px; padding: 1px 7px 4px 7px; border-bottom-left-radius: 3px; border-top-left-radius: 3px; border-width: 1px;'>&#x2699;</span><span id='fhlMidBottomWindowControl' style='top: -2px; padding-top: 2px; font-size: 24px;'>&#9776;</span><span id='fhlInfoWindowControl' style='top: 0px; padding: 1px 7px 4px 7px; border-bottom-right-radius: 3px; border-top-right-radius: 3px;'>&#9112;</span>";
    dom.html(html);
  }  
};

var help={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
    helpingPopUp.init(ps, $('#helpingPopUp'));
  },
  registerEvents:function(ps){
    this.dom.on('click', function(){
        $('#helpingPopUp').css({
            'visibility': 'visible',
            'opacity': '1'
        });
    });
  },
  render:function(ps,dom){
      var html="";
      html+='HELP';
      dom.html(html);
      this.registerEvents(ps);
  }
};

var helpingPopUp={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
  },
  render:function(ps,dom){
      var html="";
      html+='<div><ul><li>Ctrl+F: 搜尋</li><li>esc: 跳出</li></ul></div>';
      $('#helpingPopUpInside').html(html);
      this.registerEvents(ps);
  }
}
    
var bookSelect={
  init:function(ps,dom){    
    this.dom=dom;
    this.render(ps,this.dom);
    bookSelectPopUp.init(ps,$('#bookSelectPopUp'));
    bookSelectPopUp.registerEvents(ps);    
  },
  registerEvents:function(ps){
    var that=this;
    $('#bookSelect').unbind().click(function(e){// 加上unbind() 讓創世記第二章之後的dropdown不會自動消失
        if(bookSelectPopUp.dom.is(":visible")){
            bookSelectPopUp.dom.fadeOut('0.2');
            setTimeout(function(){
                bookSelect.dom.css({'color': '#FFFFFF'});
            }, 200);
        }
        else{
            bookSelectPopUp.dom.fadeIn('0.2');
            bookSelect.dom.css({'color': '#00A0FF'});
        }
        e.stopPropagation();
    });
    $(document).click(function() {
        bookSelectPopUp.dom.fadeOut('0.2');
        setTimeout(function(){ bookSelect.dom.css({'color': '#FFFFFF'}); }, 200);
    });
    $('#bookSelect').mouseenter(function(){
        if(!bookSelectPopUp.dom.is(":visible")){
            bookSelect.dom.css({'color': '#00A0FF'});
        }
    });
    $('#bookSelect').mouseleave(function(){
        if(!bookSelectPopUp.dom.is(":visible")){
            bookSelect.dom.css({'color': '#FFFFFF'});
        }
    });
  },
  render:function(ps,dom){
      var bookName=getBookFunc("bookFullName",ps.chineses);
      var html="";
      if(bookName!="詩篇")
          html=bookName+"： 第"+chineseNumber[ps.chap]+"章";
      else
          html=bookName+"： 第"+chineseNumber[ps.chap]+"篇";
      html+='&nbsp;&#9660;';
      dom.html(html);
      this.registerEvents(ps);
  }
};

var bookSelectPopUp={
  init:function(ps,dom){
    this.dom=dom;
    bookSelectName.init(ps,$('#bookSelectName'));    
    bookSelectName.registerEvents(ps);
    this.dom.hide();
  },
  registerEvents:function(ps){
    var that=this;
    this.dom.click(function(e) {
        e.stopPropagation();
    });
  }
};

var bookSelectName={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
    var that=this.dom;
    var isBookSelectChapterPopUp=false;
    this.dom.find('li li').click(function(){
        if(isBookSelectChapterPopUp===false){
            var idx=getBookFunc("index",$(this).attr('chineses'));
            var position=$(this).position();
            position.left=$(this).position().left;
            position.top=$(this).position().top+$(this).height()+10;
            bookSelectChapter.init(ps,$('#bookSelectChapter'),idx,position);
            bookSelectChapter.registerEvents(ps);
            that.find('li').removeClass('selected');
            $(this).addClass('selected');
            isBookSelectChapterPopUp=true;
            bookSelectChapter.dom.hide();
            bookSelectChapter.dom.show('0.2');
        }
        else{
            bookSelectChapter.dom.hide('0.2');
            isBookSelectChapterPopUp=false;
            that.find('li').removeClass('selected');
        }
    });
    this.dom.find('li li').mouseenter(function(){
        clearTimeout(bookSelectAutoCloseTimeout);
        that.find('li').removeClass('selected');
        if(isBookSelectChapterPopUp===true){
            bookSelectChapter.dom.hide('0.2');
            isBookSelectChapterPopUp=false;
        }
    });
    this.dom.find('li li').mouseleave(function(){
        bookSelectChapterAutoCloseTimeout = setTimeout(function(){
            if(isBookSelectChapterPopUp===true){
                bookSelectChapter.dom.hide('0.2');
                isBookSelectChapterPopUp=false;
                that.find('li').removeClass('selected');
            }
        }, 100);
    });
  },
  render:function(ps,dom){
      var html="<div id='old-testament'>舊約<ul><li><span>摩西五經</span><ul>";
      for(var i=0;i<5;i++)
          html+="<li>"+bookFullName[i]+"</li>";
      html+="</ul></li><li><span>歷史書</span><ul>";
      for(var i=5;i<17;i++)
          html+="<li>"+bookFullName[i]+"</li>";
      html+="</ul></li><li><span>詩歌智慧書</span><ul>";
      for(var i=17;i<22;i++)
          html+="<li>"+bookFullName[i]+"</li>";
      html+="</ul></li><li><span>大先知書</span><ul>";
      for(var i=22;i<27;i++)
          html+="<li>"+bookFullName[i]+"</li>";
      html+="</ul></li><li><span>小先知書</span><ul>";
      for(var i=27;i<39;i++)
          html+="<li>"+bookFullName[i]+"</li>";
      html+="</ul></li></ul></div><div id='new-testament'>新約<ul><li><span>福音、歷史書</span><ul>";
      for(var i=39;i<44;i++)
          html+="<li>"+bookFullName[i]+"</li>";
      /*html+="</ul></li><li><span>歷史書</span><ul>";
      for(var i=43;i<44;i++)
          html+="<li>"+bookFullName[i]+"</li>";*/
      html+="</ul></li><li><span>保羅書信</span><ul>";
      for(var i=44;i<57;i++)
          html+="<li>"+bookFullName[i]+"</li>";
      html+="</ul></li><li><span>其他、預言書</span><ul>";
      for(var i=57;i<66;i++)
          html+="<li>"+bookFullName[i]+"</li>";
      /*html+="</ul></li><li><span>預言書</span><ul>";
      for(var i=65;i<66;i++)
          html+="<li>"+bookFullName[i]+"</li>";*/
      html+="</ul></li></ul></div>";
 
      dom.html(html);
      
      for(var i=0;i<bookFullName.length;i++){
          dom.find('li li:eq('+i+')').attr('chineses',book[i]);
      }
    /*for(var i=0;i<bookFullName.length;i++){
      dom.find('li:eq('+i+')').attr('chineses',book[i]);
    }*/
  }
};

var bookSelectChapter={
  init:function(ps,dom,idx,position){
    this.dom=dom;
    this.idx=idx;
    this.dom.css({
        'position': 'absolute',
        'left':position.left,
        'top':position.top,
        'box-shadow':'3px 5px 3px 1px rgba(0,0,0,0.75)',
        'border': 'solid white 2px'
    });
    this.render(ps,this.dom,this.idx);
  },
  registerEvents:function(ps){
    var that=this;
    this.dom.find('li').click(function(){
      ps.chineses=book[that.idx];
      ps.engs=bookEng[that.idx];
      ps.chap=parseInt($(this).attr('chap'));
      ps.sec=1;
      setPageState(ps);      
      bookSelect.render(ps,bookSelect.dom);
      fhlLecture.render(ps,fhlLecture.dom);
      viewHistory.render(ps,viewHistory.dom);
      //fhlInfo.render(ps);
      bookSelectPopUp.dom.hide();
      bookSelect.dom.css({'color': '#000000'});
    });
    this.dom.mouseenter(function(){
        clearTimeout(bookSelectChapterAutoCloseTimeout);
    });
    this.dom.mouseleave(function(){
        bookSelectChapter.dom.hide('0.2');
        bookSelectName.dom.find('li li').removeClass('selected');
    });
  },
  render:function(ps,dom,idx){
    var numOfChapters=bookChapters[idx];
    var html="<ul>";
    for(var i=1;i<=numOfChapters;i++){
      html+="<li>"+i+"</li>";
    }
    dom.html(html);
    for(var i=0;i<numOfChapters;i++){
      dom.find('li:eq('+i+')').attr('chap',i+1);
    }
  }
};


/***** End of fhlToolBar *****/
    
/***** Start of fhlLeftWindow *****/
    
var fhlLeftWindow={
  init:function(ps){
      settings.init(ps,$('#settings'));
      settings.registerEvents(ps);
      versionSelect.init(ps,$('#versionSelect'));
      //versionSelect.registerEvents(ps);
      viewHistory.init(ps,$('#viewHistory'));
      this.registerEvents();
  },
  registerEvents:function(){
      $('#fhlLeftWindow').resizable({
        handles: 'e',
        maxWidth: 300,
        minWidth: 170,
        resize: function(event, ui){
          var currentWidth = ui.size.width;
          var width;
            if($("#fhlInfo").css('right')=='12px')
                width=$(window).width()-$("#fhlInfo").width()-currentWidth;
            else 
                width=$(window).width()-currentWidth+12;
          $("#fhlMidWindow").css({
              'width': width-12*4+'px',
              'left': currentWidth+12+12+'px'
          });
        }
      });
      $('.ui-resizable-handle.ui-resizable-e').html('<span>&#9776;</span>');
  }
};
    
var settings={
    init:function(ps,dom){
        this.dom=dom;
        this.render(ps,this.dom);
        snSelect.init(ps,$('#snSelect'));
        snSelect.registerEvents(ps);
        realTimePopUpSelect.init(ps,$('#realTimePopUpSelect'));
        realTimePopUpSelect.registerEvents(ps);
        gbSelect.init(ps,$('#gbSelect'));
        gbSelect.registerEvents(ps);
        mapTool.init(ps,$('#mapTool'));
        mapTool.registerEvents(ps);
        imageTool.init(ps,$('#imageTool'));
        imageTool.registerEvents(ps);
        fontSizeTool.init(ps,$('#fontSizeTool'));
        fontSizeTool.registerEvents(ps);
    },
    registerEvents:function(ps){
        $('#settings p')
            .on('click', function(){
                var html =  $(this).html() == "▼&nbsp;設定"?"&#9654;&nbsp;設定":"&#9660;&nbsp;設定";
                $(this).html(html);
                if($(this).html()=="▼&nbsp;設定"){
                    var settingsHeight = Math.min(300, $('#fhlLeftWindow').height()-42-$('#viewHistory').height()-36);
                    $("#settings").animate( { height: settingsHeight + 'px' }, { queue:false, duration:500 });
                    var versionSelectHeight = settingsHeight < 300 ? 42 : $("#versionSelect").height() - settingsHeight + 42;//bug: 前面會變41不會變42不知道為什麼，所以用這行修正
                    $("#versionSelect").animate( { top: settingsHeight+12+'px', height: versionSelectHeight + 'px' }, { queue:false, duration:500 });
                    var html = versionSelectHeight == 42?"&#9654;&nbsp;聖經版本選擇":"&#9660;&nbsp;聖經版本選擇";
                    $('#versionSelect p').html(html);
                }
                else{
                    var versionSelectHeight = $("#versionSelect").height() + $("#settings").height() - 42;
                    $("#versionSelect").animate( { top: 42+12+'px', height: versionSelectHeight + 'px' }, { queue:false, duration:500 });
                    $("#settings").animate( { height:'42px' }, { queue:false, duration:500 });
                    $("#versionSelect p").html("&#9660;&nbsp;聖經版本選擇");
                    
                }
        });
        $('#settings').resizable({
            handles: 's',
            maxHeight: 300,
            minHeight: 42,
            resize: function(event, ui){
              var maxHeight = $('#fhlLeftWindow').height() - 42 - $('#viewHistory').height() -36;
              if(ui.size.height>maxHeight){//不可以超過其他的bar
                  ui.size.height=maxHeight;
                  $("#versionSelect p").html("&#9654;&nbsp;聖經版本選擇");
              }
              var height=$('#fhlLeftWindow').height()-$('#viewHistory').height()-ui.size.height;
              $("#versionSelect").css({
                  'top': ui.size.height + 12 + 'px',
                  'height': height - 36 +'px'
              });
              $(this).css({
                  width: 'auto',
                  right: '0px'
              });
              var html = $(this).css('height') == '42px'?"&#9654;&nbsp;設定":"&#9660;&nbsp;設定";
              $('#settings p').html(html);
              var html = $('#versionSelect').css('height') == '42px'?"&#9654;&nbsp;聖經版本選擇":"&#9660;&nbsp;聖經版本選擇";
              $('#versionSelect p').html(html);
            }
        });
        $('.ui-resizable-handle.ui-resizable-s').html('<span>&#9776;</span>');
    },
    render:function(ps,dom){
        //dom.html("設定");
    }
};
var snSelect={
    init:function(ps,dom){
        this.dom=dom;
        this.render(ps,this.dom);
    },
    registerEvents:function(ps){
        $('#snOnOffSwitch').change(
        function(){
            if ($(this).is(':checked')) {
                ps.strong=1;
                fhlLecture.render(ps,fhlLecture.dom);
            }
            else{
                ps.strong=0;
                fhlLecture.render(ps,fhlLecture.dom);
            }
            setPageState(ps);
        });
    },
    render:function(ps,dom){
        var html="<div>原文編號:</div>";
        html+='<div class="onOffSwitch">\
                    <input type="checkbox" name="snOnOffSwitch" class="onOffSwitch-checkbox" id="snOnOffSwitch">\
                    <label class="onOffSwitch-label" for="snOnOffSwitch">\
                        <span class="onOffSwitch-inner"></span>\
                        <span class="onOffSwitch-switch"></span>\
                    </label>\
                </div>';
        dom.html(html);
    }
};
var gbSelect={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
      $('#gbSelectSwitch').change(
        function(){
            if ($(this).is(':checked')) {
                ps.gb=1;
                fhlLecture.render(ps,fhlLecture.dom);
            }
            else{
                ps.gb=0;
                fhlLecture.render(ps,fhlLecture.dom);
            }
            setPageState(ps);
        });
  },
  render:function(ps,dom){
      var html="<div>繁簡切換:</div>";
        html+='<div class="onOffSwitch">\
                    <input type="checkbox" name="gbSelectSwitch" class="onOffSwitch-checkbox" id="gbSelectSwitch">\
                    <label class="onOffSwitch-label" for="gbSelectSwitch">\
                        <span class="onOffSwitch-inner traditional-simpleSwitch"></span>\
                        <span class="onOffSwitch-switch"></span>\
                    </label>\
                </div>';
        dom.html(html);
  }
};
var realTimePopUpSelect={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
      $('#realTimeOnOffSwitch').change(
        function(){
            if ($(this).is(':checked')) {
                ps.realTimePopUp=1;
                fhlLecture.render(ps,fhlLecture.dom);
            }
            else{
                ps.realTimePopUp=0;
                fhlLecture.render(ps,fhlLecture.dom);
            }
            setPageState(ps);
        });
  },
  render:function(ps,dom){
      var html="<div>即時顯示:</div>";
        html+='<div class="onOffSwitch">\
                    <input type="checkbox" name="realTimeOnOffSwitch" class="onOffSwitch-checkbox" id="realTimeOnOffSwitch">\
                    <label class="onOffSwitch-label" for="realTimeOnOffSwitch">\
                        <span class="onOffSwitch-inner"></span>\
                        <span class="onOffSwitch-switch"></span>\
                    </label>\
                </div>';
        dom.html(html);
  }
};
var mapTool={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
  },
  render:function(ps,dom){
    var html="<div>地圖顯示:</div>";
        html+='<div class="onOffSwitch">\
                    <input type="checkbox" name="mapToolOnOffSwitch" class="onOffSwitch-checkbox" id="mapToolOnOffSwitch">\
                    <label class="onOffSwitch-label" for="mapToolOnOffSwitch">\
                        <span class="onOffSwitch-inner"></span>\
                        <span class="onOffSwitch-switch"></span>\
                    </label>\
                </div>';
        dom.html(html);
  }
};
var imageTool={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
  },
  render:function(ps,dom){
    var html="<div>圖片顯示:</div>";
        html+='<div class="onOffSwitch">\
                    <input type="checkbox" name="imageToolOnOffSwitch" class="onOffSwitch-checkbox" id="imageToolOnOffSwitch">\
                    <label class="onOffSwitch-label" for="imageToolOnOffSwitch">\
                        <span class="onOffSwitch-inner"></span>\
                        <span class="onOffSwitch-switch"></span>\
                    </label>\
                </div>';
        dom.html(html);
  }
};
var fontSizeTool={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
      $('#fhlLectureFontSizeSliderBar').change(function() {
          $("#fhlLectureFontSize").val($('#fhlLectureFontSizeSliderBar').val());
          $('#fhlLecture .lec').css({
              'font-size':$('#fhlLectureFontSize').val()+'pt',
              'line-height':parseInt($('#fhlLectureFontSize').val())+4+'pt'
          });
      });
      $('#fhlLectureFontSize').change(function() {
          if($('#fhlLectureFontSize').val()>60)
              $('#fhlLectureFontSize').val(60);
          else if($('#fhlLectureFontSize').val()<6)
              $('#fhlLectureFontSize').val(6);
          $('#fhlLectureFontSizeSliderBar').val($('#fhlLectureFontSize').val());
          $('#fhlLecture .lec').css({
              'font-size':$('#fhlLectureFontSize').val()+'pt',
              'line-height':parseInt($('#fhlLectureFontSize').val())+4+'pt'
          });
      });
      $('#fhlLectureFontSizeSmaller').click(function() {
          $('#fhlLectureFontSize').val(parseInt($('#fhlLectureFontSize').val())-2);
          if($('#fhlLectureFontSize').val()<=6)
              $('#fhlLectureFontSize').val(6);
          $("#fhlLectureFontSizeSliderBar").val($('#fhlLectureFontSize').val());
          $('#fhlLecture .lec').css({
              'font-size':$('#fhlLectureFontSize').val()+'pt',
              'line-height':parseInt($('#fhlLectureFontSize').val())+4+'pt'
          });
      });
      $('#fhlLectureFontSizeLarger').click(function() {
          $('#fhlLectureFontSize').val(parseInt($('#fhlLectureFontSize').val())+2);
          if($('#fhlLectureFontSize').val()>=60)
              $('#fhlLectureFontSize').val(60);
          $("#fhlLectureFontSizeSliderBar").val($('#fhlLectureFontSize').val());
          $('#fhlLecture .lec').css({
              'font-size':$('#fhlLectureFontSize').val()+'pt',
              'line-height':parseInt($('#fhlLectureFontSize').val())+4+'pt'
          });
      });
  },
  render:function(ps,dom){
    var html="<div>字體大小:</div>";
        html+=' <div id="fhlLectureFontSizeSmaller">A<span>-</span></div>\
                <div id="fhlLectureFontSizeLarger">A<span>+</span></div>\
                <div style="display: block; margin-top: 5px;">\
                    <input id="fhlLectureFontSizeSliderBar" type="range" min="6" max="60" value="12" step="1"/>\
                    <input id="fhlLectureFontSize" type="text" value="12" style="width:16px;"/>\
                </div>\
                ';
        dom.html(html);
  }
};
    
function getVersionIdx(book){    
  return $('#versionSelect').find("li[book="+book+"]").index();
}
function insertVersion(ps,dom){
  var book=dom.attr('book');
  var cname=dom.attr('cname');  
  var versionIdx=getVersionIdx(book);
  var inserted=false;
  //console.log('book='+book+",cname="+cname+",idx="+versionIdx);
  for(var i=0;i<ps.version.length;i++){
    if(versionIdx<getVersionIdx(ps.version[i])){
      ps.version.splice(i,0,book);
      ps.cname.splice(i,0,cname);
      inserted=true;
      break;
    }
  }
  if(inserted==false){
      ps.version.push(book);
      ps.cname.push(cname);
  }
}

var versionSelect={
    init:function(ps,dom){
        this.dom=dom;
        var that=this;    
        var ajaxUrl=urlJSON+"abv.php";
        $.ajax({
          url:ajaxUrl
        }).done(function(d,s,j){
          if(j){
            var jsonObj=JSON.parse(j.responseText);
            that.data=jsonObj;
          }    
          that.render(ps,dom,that.data);  
        });
        var versionSelectHeight = $('#fhlLeftWindow').height() - $('#settings').height() - $('#viewHistory').height() - 36;
        $('#versionSelect').css({height: versionSelectHeight + 'px'});
    },
    registerEvents:function(ps){
      $('#versionSelect p').on('click', function(){
        var html =  $(this).html() == "▼&nbsp;聖經版本選擇"?"&#9654;&nbsp;聖經版本選擇":"&#9660;&nbsp;聖經版本選擇";
        $(this).html(html);
        if($(this).html()=="▼&nbsp;聖經版本選擇"){
            var versionSelectHeight = $('#fhlLeftWindow').height() - $('#settings').height() - 42 - 36;
            var viewHistoryTop = $('#fhlLeftWindow').height() - 42 -12;
            $("#versionSelect").animate( { height: versionSelectHeight + 'px' }, { queue:false, duration:500 });
            $("#viewHistory").animate( { height: '42px', top:viewHistoryTop + 'px' }, { queue:false, duration:500 });
            $("#viewHistory p").html("&#9654;&nbsp;歷史紀錄");
        }
        else{
            var viewHistoryHeight = $('#fhlLeftWindow').height() - $('#settings').height() - 42 - 36;
            var viewHistoryTop = $('#fhlLeftWindow').height() - viewHistoryHeight - 12;
            $("#versionSelect").animate( { height:'42px' }, { queue:false, duration:500 });
            $("#viewHistory").animate( { height: viewHistoryHeight + 'px', top: viewHistoryTop + 'px' }, { queue:false, duration:500 });
            $("#viewHistory p").html("&#9660;&nbsp;歷史紀錄");
        }
      });    
      var that=this;
      this.dom.find('li').click(function(e){
          $(this).toggleClass('selected');
          if($(this).hasClass('selected')){
            insertVersion(ps,$(this));        
            /*
            ps.version.push($(this).attr('book'));
            ps.cname.push($(this).attr('cname'));
            */
            //$(this).html("&#x2713"+$(this).html());
          }else{
            var idx=ps.version.indexOf($(this).attr('book'));
            ps.version.splice(idx,1);
            ps.cname.splice(idx,1);
            //$(this).html($(this).html().substr(1, $(this).html().length-1));
          }
          //Set Default version?      
          if(ps.version.length==0){
            var o=that.dom.find('li:eq(0)');
            ps.version.push(o.attr('book'));
            ps.cname.push(o.attr('cname'));
          }
          setPageState(ps);
          fhlLecture.render(ps,fhlLecture.dom);
          e.stopPropagation();
      });
      $('#versionSelect').resizable({
        handles: 's',
        maxHeight: 1006,
        minHeight: 42,
        resize: function(event, ui){
          var maxHeight = $('#fhlLeftWindow').height() - $('#settings').height() - 42 - 36;
          if(ui.size.height>maxHeight){//不可以超過其他的bar
              ui.size.height=maxHeight;
          }
          var height=$('#fhlLeftWindow').height()-$('#settings').height()-ui.size.height-36;
          $("#viewHistory").css({
              'height': height+'px',
              'top': $('#settings').height()+ui.size.height+24+'px'
          });
          $(this).css({
              width: 'auto',
              right: '0px'
          });
          var html = $(this).css('height') == '42px'?"&#9654;&nbsp;聖經版本選擇":"&#9660;&nbsp;聖經版本選擇";
          $('#versionSelect p').html(html);
          var html = $('#viewHistory').css('height') == '42px'?"&#9654;&nbsp;歷史紀錄":"&#9660;&nbsp;歷史紀錄";
          $('#viewHistory p').html(html);
        }
      });
      $('.ui-resizable-handle.ui-resizable-s').html('<span>&#9776;</span>');
    },
    render:function(ps,dom, data){
        var that=this;
        var html="<div class='secondLevelInside'><p>&#9660;&nbsp;聖經版本選擇</p><div><ul>";
        for(var i=0;i<data.record_count;i++){
          var o=data.record[i];
          html+="<li>"+o.cname+"</li>";
        }
        html+="</ul></div></div>";
        dom.html(html);
        for(var i=0;i<data.record_count;i++){
          var o=data.record[i];
          dom.find('li:eq('+i+')').attr(o);
        }        
        dom.find('li').removeClass('selected');
        for(var i=0;i<ps.version.length;i++){
          var v=ps.version[i];
          var li=dom.find('li[book="'+v+'"]');
          if(li!=null){
            li.each(function(){
              $(this).addClass('selected');
              var html="";/*&#x2713*/
              html+=$(this).html();
              $(this).html(html);
            });
          }
        }
        that.registerEvents(ps);    
      }
};

function setBook(ps,bookName){
  var idx=null;
  if(book.indexOf(bookName)!=-1){
    idx=book.indexOf(bookName);
  }else if(bookEng.indexOf(bookName)!=-1){
    idx=book.indexOf(bookName);
  }else{
    idx=null;
  }
  if(idx!=null){
    ps.chineses=book[idx];
    ps.engs=bookEng[idx];
  }else{
    console.log('setBook error:idx is null');
  }
}    
var viewHistory={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
    var viewHistoryTop = $('#fhlLeftWindow').height() - 42 - 12;
    $('#viewHistory').css({top:viewHistoryTop});
  },
  registerEvents:function(ps){
    var that=this;
    $('#viewHistory p')
        .on('click', function(){
            var html =  $(this).html() == "▼&nbsp;歷史紀錄"?"&#9654;&nbsp;歷史紀錄":"&#9660;&nbsp;歷史紀錄";
            $(this).html(html);
            if($(this).html()=="▼&nbsp;歷史紀錄"){
                var viewHistoryHeight = Math.min(36*ps.history.length+64, $('#fhlLeftWindow').height() - $('#settings').height() - 42 - 36);
                var viewHistoryTop = $('#fhlLeftWindow').height() - viewHistoryHeight -12;
                if(viewHistoryHeight == 36*ps.history.length+64){
                    var versionSelectHeight = $("#versionSelect").height() + $("#viewHistory").height() - viewHistoryHeight;
                    $("#versionSelect").animate( { height: versionSelectHeight + 'px' }, { queue:false, duration:500 });
                }
                else{
                    $("#versionSelect").animate( { height: '42px' }, { queue:false, duration:500 });
                    $("#versionSelect p").html("&#9654;&nbsp;聖經版本選擇");
                }
                $("#viewHistory").animate( { height: viewHistoryHeight + 'px', top:viewHistoryTop + 'px' }, { queue:false, duration:500 });
                $("#viewHistory p").html("&#9660;&nbsp;歷史紀錄");
            }
            else{
                var versionSelectHeight = $('#fhlLeftWindow').height() - $('#settings').height() - 42 - 36;
                var viewHistoryTop = $('#fhlLeftWindow').height() - 42 - 12;
                $("#versionSelect").animate( { height: versionSelectHeight + 'px' }, { queue:false, duration:500 });
                $("#versionSelect p").html("&#9660;&nbsp;聖經版本選擇");
                $("#viewHistory").animate( { height: '42px', top: viewHistoryTop + 'px' }, { queue:false, duration:500 });
                $("#viewHistory p").html("&#9654;&nbsp;歷史紀錄");
            } 
    });
    $('.clearHistory').click(function(){
      ps.history=[{chineses:ps.chineses,chap:ps.chap}];      
      setPageState(ps);
      viewHistory.render(ps,viewHistory.dom);
    });    
    this.dom.find('li')
    .css({cursor: "pointer"})
    .click(function(){      
      setBook(ps,$(this).attr('chineses'));
      ps.chap=parseInt($(this).attr('chap'));
      ps.sec=1;
      setPageState(ps);    
      bookSelect.render(ps,bookSelect.dom);      
      fhlInfo.render(ps,fhlInfo.dom);
      fhlLecture.render(ps,fhlLecture.dom);
    });    
  },
  render:function(ps,dom){
    var html="<div class='secondLevelInside'>";
    if($("#viewHistory").height()==42)
        html+="<p>&#9654;&nbsp;歷史紀錄</p>";
    else
        html+="<p>&#9660;&nbsp;歷史紀錄</p>";
    html+="<span class='clearHistory'>清除記錄</span><div><ul class='viewHistoryList'>";
    for(var i=ps.history.length-1;i>=0;i--){
      var r=ps.history[i];
      html+="<li chineses="+r.chineses+" chap="+r.chap+">";
      html+=r.chineses+":"+r.chap+"</li>";
    }
    html+="</ul></div></div>";
    dom.html(html);
    this.registerEvents(ps);
  }
};

       
/***** End of fhlLeftWindow *****/

/***** Start of fhlMidWindow *****/
var fhlMidWindow={
    init:function(ps,dom){
        this.dom=dom;
        fhlLecture.init(pageState,$('#fhlLecture'));
        fhlMidBottomWindow.init(pageState,$('#fhlMidBottomWindow'));
        this.render(ps,dom);
    },
    render:function(ps,dom){
        var width=$(window).width()-$("#fhlLeftWindow").width()-$("#fhlInfo").width()-12*4;
        $("#fhlMidWindow").css({
            'width': width+'px'
        });
    }
}
    
function setCSS(col,ps){
  var totalWidth=100;
  $('.lecContent').css('width',(totalWidth/col)+"%");
  $('.lecVersion').css('width',(totalWidth/col)+"%");
}

function setFont(){
  $('.bhs').addClass('hebrew');
  $('.nwh').addClass('greek');
}

function getBibleText(col,ps,cbk,defCbk){
  var sem=col;
  //console.log("enter getBibleText");
  for(var i=0;i<col;i++){
    //console.log("launch ajax"+i);
    var ajaxUrl=getAjaxUrl("qb",ps,i);    
    $.ajax({
      url:ajaxUrl
    }).done(function(d,s,j){
      if(j){
        //console.log(j.responseText);
        var jsonObj=JSON.parse(j.responseText);
        cbk(jsonObj);
        sem--;
      }
    });
  }  
  var def=setInterval(function(){
    if(sem==0){
      defCbk();
      clearInterval(def);
    }
  },100);
}

function checkOldNew(ps){
//0 - Old 
//1 - New
  return (book.indexOf(ps.chineses)>=39)?0:1;  
}

function parseBibleText(text,ps,isOld,bibleVersion){
  var ret;
  checkOldNew(ps);
  switch(ps.strong){
    case 0:
      ret=text;
      break;
    case 1:
      //console.log(text);
      if(bibleVersion=="和合本"||bibleVersion=="KJV"){
        text=text.replace(/[{}]/g,"");
        text=text.replace(/>/g,"&gt;</span>");
        text=text.replace(/<W[a-zA-Z]*/g,"<span class='sn' N="+isOld+">&lt;");
      }
      //console.log(text);
      ret=text;
      break;
    default:
      ret=text;
      break;
  }  
  if(bibleVersion=="舊約馬索拉原文"||bibleVersion=="新約WH原文"){    
    ret=ret.replace(/</g,"&lt");
    ret=ret.replace(/>/g,"&gt");          
    ret=ret.replace(/\r\n/g,"<br>");
  }  
  return ret;
}

function getRecord(r,b,c,s){
  var ret=null;
  for(var i=0;i<r.length;i++){
    if(r[i]==null)
      break;
    if(r[i].chap==c&&r[i].sec==s){
      ret=r[i];
      break;
    }
  }
  return ret;
}

function sortBibleVersion(r,ps){
  var tmpArr=new Array();
  for(var i=0;i<ps.version.length;i++){
    var version=ps.version[i];
    for(var j=0;j<r.length;j++){
      if(version==r[j].version){
        tmpArr.push(r[j]);
      }
    }
  }
  return tmpArr;
}

var fhlLecture={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,dom);
  },
  selectLecture:function(book,chap,sec){
    var that=this.dom;
    that.find('.lec').removeClass('selected');
    var obj=that.find('.lec'+'[sec="'+sec+'"]');
    obj.addClass('selected');
    that.scrollTop(that.scrollTop()+obj.position().top);    
    //console.dir(obj.position());
  },
  registerEvents:function(ps){
    var that=this.dom;
    that.find('.lec').click(function(){
      ps.sec=parseInt($(this).attr('sec'));
      ps.chap=parseInt($(this).attr('chap'));
      $(that).find('.lec').removeClass('selected');
      $(this).addClass('selected');
      setPageState(ps);      
      fhlInfo.render(ps);
    });
    $('.closeButton').click(function(e){
      var idx=ps.version.indexOf(versionSelect.dom.find('li[cname='+$(this).attr('cname')+']').attr('book'));
      ps.version.splice(idx,1);
      ps.cname.splice(idx,1);
      versionSelect.dom.find('li[cname='+$(this).attr('cname')+']').removeClass('selected');
      //Set Default version?
      if(ps.version.length==0){
        var o=versionSelect.dom.find('li:eq(0)');
        ps.version.push(o.attr('book'));
        ps.cname.push(o.attr('cname'));
        versionSelect.dom.find('li:eq(0)').addClass('selected');
      }
      setPageState(ps);
      fhlLecture.render(ps,fhlLecture.dom);
      e.stopPropagation();
        
    });
    if(ps.realTimePopUp==1){
      $('.sn').mouseenter(function(){
        var offset=$(this).offset();
        offset.top+=$(this).height()+10;
        ps.N=$(this).attr('N');
        ps.k=$(this).html().replace(/&lt;/g,"").replace(/&gt;/g,"");
        parsingPopUp.render(ps,parsingPopUp.dom,offset);
      });
    }else{
      $('.sn').click(function(){
        var offset=$(this).offset();
        offset.top+=$(this).height()+10;
        ps.N=$(this).attr('N');
        ps.k=$(this).html().replace(/&lt;/g,"").replace(/&gt;/g,"");
        parsingPopUp.render(ps,parsingPopUp.dom,offset);
      });    
    }
    $('.chapBack').click(function(e){
      var idx=getBookFunc("index",ps.chineses);
      if(ps.chap==1){
        ps.chineses=book[idx-1];
        ps.engs=bookEng[idx-1];
        ps.chap=bookChapters[idx-1];
      }else{
        ps.chap--;        
      }
      setPageState(ps);
      viewHistory.render(ps,viewHistory.dom);
      fhlLecture.render(ps,fhlLecture.dom);
      //fhlInfo.render(ps);
      bookSelect.render(ps, bookSelect.dom);
      e.stopPropagation();
    });
    $('.chapNext').click(function(e){      
      var idx=getBookFunc("index",ps.chineses);
      if(ps.chap==bookChapters[idx]){//if last chapter
        ps.chineses=book[idx+1];//book+1
        ps.engs=bookEng[idx+1];
        ps.chap=1;
      }else{
        ps.chap++;
      }
      setPageState(ps);
      viewHistory.render(ps,viewHistory.dom);
      fhlLecture.render(ps,fhlLecture.dom);
      //fhlInfo.render(ps);
      bookSelect.render(ps, bookSelect.dom);
      e.stopPropagation();
    });
    /*$('.sn').mouseleave(function(){
      parsingPopUp.dom.hide();
    });*/
  },
  render:function(ps,dom){
    //console.log('start of fhlLecture render');
    var that=this;
    var htmlTitle="";
    var htmlContent="";
    var col=ps.version.length;
    var rspArr=new Array();
    var idx=0;
    getBibleText(col,ps,function(o){
        rspArr.push(o);
    },function(){                
      var isOld=checkOldNew(ps);
      var maxRecordCnt=0;
      var maxRecordIdx=0;
      rspArr=sortBibleVersion(rspArr,ps);
      for(var i=0;i<rspArr.length;i++){
        var o=rspArr[i];
        htmlTitle+="<div class=lecContent><div class=versionName>"+o.v_name+"<span class='closeButton' cname='"+o.v_name+"'>&#215</span></div></div>";
        if(rspArr[i].record_count>maxRecordCnt){
          maxRecordCnt=rspArr[i].record_count;
          maxRecordIdx=i;          
          //console.log("maxRecordCnt:"+maxRecordCnt+",maxRecordIdx:"+maxRecordIdx);
        }        
      }        
      for(var i=0;i<maxRecordCnt;i++){
        var maxR=rspArr[maxRecordIdx].record[i];
        htmlContent+="<div class=lec>";
        //htmlContent+="<div class=lecTitle>"+maxR.chap+":"+maxR.sec+"</div>";
        for(j=0;j<rspArr.length;j++){
          var chap=maxR.chap,sec=maxR.sec;                
          var rec=getRecord(rspArr[j].record,null,chap,sec);
          //var r=rspArr[j].record[i];
          if(rec!=null){
            var bibleText=parseBibleText(rec.bible_text,ps,isOld,rspArr[j].v_name);
            if(bibleText=="a")
                bibleText="【併入上節】";
          }else{
            bibleText="";
          }
          htmlContent+="<div class='lecContent "+rspArr[j].version+"'><div style='margin: 0px 20px 0px 1px; padding: 7px 0px; height: 100%;'><span class='verseNumber'>"+maxR.sec+"</span>"+bibleText+"</div></div>";
        }
        htmlContent+="</div>";        
      }
      
      var control_str="";
      var bookName=getBookFunc("bookFullName",ps.chineses);
      if(bookName!="failed"){
        if(ps.chineses==book[0]&&ps.chap==1){
          control_str+="";
        }else{
          control_str+="<div class='chapBack chapControl' style='left: 0px;'><span>&#x276e;</span></div>";
        }      
        /*control_str+="<span class='chapSelect'>"+bookName;
        control_str+="&nbsp&nbsp"+ps.chap+"</span>";*/
        if(ps.chineses==book[65]&&ps.chap==22){
          control_str+="";
        }else{
          control_str+="<div class='chapNext chapControl' style='right: 0px;'><span>&#x276f;</span></div>";
        }            
      }
        
      var html=control_str+'<div id="lecMainTitle">'+htmlTitle+'</div>';
      html+='<div id="lecMain">'+htmlContent+'</div>';
      dom.html(html);
      for(var i=0;i<maxRecordCnt;i++){
        var r=rspArr[maxRecordIdx].record[i];
        dom.find('.lec:eq('+i+')').attr('chap',r.chap);
        dom.find('.lec:eq('+i+')').attr('sec',r.sec);
      }
      setCSS(col,ps);
      setFont();      
      that.selectLecture(null,null,ps.sec);
      that.registerEvents(ps);
      //console.log('End of fhlLecture render');      
    });
  }
};

var fhlMidBottomWindow={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,dom);
    this.registerEvents(ps);
  },
  registerEvents:function(ps){
      $('#fhlMidBottomWindow').resizable({
        handles: 'n',
        maxHeight: 600,
        minHeight: 100,
        resize: function(event, ui){
          var height=$(window).height()-ui.size.height-120-12;
          $("#fhlLecture").css({
              'height': height -12 +'px',
          });
          $(this).css({
              'width': '100%'
          });
        }
      });
      $('.ui-resizable-handle.ui-resizable-n').html('<span>&#9776;</span>');
  },
  render:function(ps,dom){

      var html=(ps.leftBtmWinShow==true)?"&#9661":"&#9651";
      html+="fhlMidBottomWindowTitle";
      $('#fhlMidBottomWindowTitle').html(html);
      
      var fhlMidBottomWindowHeight = 300; /*如果這裡改了 css #fhlLecture, #fhlMidBottomWindow裡面也要改*/
      $('#fhlMidBottomWindow').css({'top': $('#fhlMidWindow').height()-fhlMidBottomWindowHeight + 'px'});
  }
};
/***** End of fhlMidWindow *****/

/***** Start of fhlInfo *****/
var fhlInfo={
  init:function(ps){
    bibleAudio.init(ps,$('#bibleAudio'));
    bibleAudio.registerEvents(ps);  
    fhlInfoTitle.init(ps,$('#fhlInfoTitle'));
    fhlInfoTitle.registerEvents(ps);
    fhlInfoContent.init(ps,$('#fhlInfoContent'));    
    fhlInfoContent.registerEvents(ps);
    parsingPopUp.init(ps,$('#parsingPopUp'));
    this.registerEvents();
    this.render(ps);
      var fhlInfoWidth = 500;//這邊改了，css裡面也要改
    $('#fhlInfo').css({'left': $(window).width()-fhlInfoWidth-12 + 'px'});// 12 是外面border
  },
  registerEvents:function(){
      $('#fhlInfo').resizable({
        handles: 'w',
        maxWidth: 650,
        minWidth: 280,
        resize: function(event, ui){
            var currentWidth = ui.size.width;
            var width=0;
            if($("#fhlLeftWindow").css('left')=='12px')
                width=$(window).width()-$("#fhlLeftWindow").width()-currentWidth;
            else
                width=$(window).width()-currentWidth+12;
            $("#fhlMidWindow").css({
              'width': width-48+'px',
              'right': currentWidth+'px'
            });
        }
      });
      $('.ui-resizable-handle.ui-resizable-w').html('<span>&#9776;</span>');
  },
  render:function(ps){
    //fhlInfoTitle.render(ps,$('#fhlInfoTitle'));
    fhlInfoContent.render(ps,fhlInfoContent.dom);
  }
};
    
var bibleAudio={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){

  },
  render:function(ps,dom){
    var html="有聲聖經 ";
    if(ps.chineses==book[0]&&ps.chap==1){
      html+="";
    }else{
      html+="<img class='menuImage' src='./images/lastChapter.png'/>";    
    }      
    if(ps.audio==0){
      html+="<img class='menuImage' src='./images/audioPlay.png'/>";    
    }else{
      html+="<img class='menuImage' src='./images/audioPause.png'/>";    
    }    
    if(ps.chineses==book[65]&&ps.chap==22){
      html+="";
    }else{
      html+="<img class='menuImage' src='./images/nextChapter.png'/>";
    }    
    dom.html(html);
  }
}

var fhlInfoTitle={
  init:function(ps,dom){
    this.dom=dom;
    this.title=[
              {"name":"原文","id":"fhlInfoParsing"},
              {"name":"註釋","id":"fhlInfoComment"},
              {"name":"講道","id":"fhlInfoPreach"},
              {"name":"串珠","id":"fhlInfoTsk"},
              {"name":"典藏","id":"fhlInfoOb"},
              {"name":"有聲","id":"fhlInfoAudio"}
      ];    
    this.render(ps,this.dom);    
  },
  registerEvents:function(ps){
    //select all elements of info title
    var selectAll="";
    for(var i=0;i<this.title.length;i++){
      selectAll+="#"+this.title[i].id+",";      
    }    
    selectAll=selectAll.substring(0,selectAll.length-1);
    $(selectAll).click(function(){      
      $(selectAll).removeClass('selected');
      $(this).addClass('selected');
      ps.titleId=$(this).attr('id');
      setPageState(ps);
      fhlInfoContent.render(ps,fhlInfoContent.dom);
    });
  },  
  render:function(ps,dom){
    var html="<ul>";
    for(var i=0;i<this.title.length;i++){
      html+="<li>"+this.title[i].name+"</li>";
    }
    html+="</ul>";
    dom.html(html);
    for(var i=0;i<this.title.length;i++){
      dom.find('li:eq('+i+')').attr('id',this.title[i].id);
    }  
    $('#'+ps.titleId).addClass('selected');  
  }
};

var fhlInfoContent={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
    var that=this;
    switch(ps.titleId){
      case "fhlInfoParsing":
        if(ps.realTimePopUp==1){
          $('.parsing').mouseenter(function(){
            var offset=$(this).offset();
            offset.top+=$(this).height()+10;
            ps.N=$(this).attr('N');
            ps.k=$(this).attr('k');
            var par=decodeURIComponent($(this).attr('par'));
            parsingPopUp.render(ps,parsingPopUp.dom,offset,par);
          });
          /*$('.parsing').mouseleave(function(){
            parsingPopUp.dom.hide();
          });*/
          $('.parsingTable').mouseenter(function(){
            var offset=$(this).offset();
            offset.top+=$(this).height()+10;
            ps.N=$(this).attr('N');
            ps.k=$(this).attr('k');
            parsingPopUp.render(ps,parsingPopUp.dom,offset,"psn");
          });
          /*$('.parsingTable').mouseleave(function(){
            parsingPopUp.dom.hide();
          });*/
        }else{
          $('.parsing').click(function(){
            var offset=$(this).offset();
            offset.top+=$(this).height()+10;
            ps.N=$(this).attr('N');
            ps.k=$(this).attr('k');
            var par=decodeURIComponent($(this).attr('par'));
            parsingPopUp.render(ps,parsingPopUp.dom,offset,par);
          });
          $('.parsingTable').click(function(){
            var offset=$(this).offset();
            offset.top+=$(this).height()+10;
            ps.N=$(this).attr('N');
            ps.k=$(this).attr('k');
            parsingPopUp.render(ps,parsingPopUp.dom,offset,"psn");
          });                    
        }

        $('.secBack, .secNext').click(function(){
          var oldEngs=ps.engs;
          var oldChap=ps.chap;
          ps.engs=$(this).attr('engs');
          var idx=getBookFunc('indexByEngs',ps.engs);
          ps.chineses=book[idx];          
          ps.chap=$(this).attr('chap');
          ps.sec=$(this).attr('sec');          
          setPageState(ps);
          bookSelect.render(ps,bookSelect.dom);          
          if(oldEngs!=ps.engs||oldChap!=ps.chap)
            fhlLecture.render(ps,fhlLecture.dom);          
          fhlInfo.render(ps);
          fhlLecture.selectLecture(null,null,ps.sec);
        });     
        break;
      case "fhlInfoComment":
        $('.commentSecBack, .commentSecNext, .commentBackground, .commentJump').click(function(){
          var oldEngs=ps.engs;
          var oldChap=ps.chap;
          ps.engs=$(this).attr('engs');
          var idx=getBookFunc('indexByEngs',ps.engs);
          ps.chineses=book[idx];
          ps.chap=$(this).attr('chap');
          ps.sec=$(this).attr('sec');
          setPageState(ps);
          bookSelect.render(ps,bookSelect.dom);
          if(oldEngs!=ps.engs||oldChap!=ps.chap)
            fhlLecture.render(ps,fhlLecture.dom);
          fhlInfo.render(ps);
          $('#fhlInfoContent').scrollTop(0);
        });
        $('.commentSecBack').css({
            "display": "block",
            "color": "rgba(100, 100, 100, 0.3)",
            "cursor": "pointer",
            "position": "absolute",
            "left": "0px",
            "height": "80px",
            "width": "40px", 
            "font-size": "3em",
            "line-height": "80px"
        }).hover(function(){
            $('.commentSecBack').css({
                "color": "rgba(255, 0, 0, 1)"/*,
                "background": "linear-gradient(to right, rgba(100,100,100,1), rgba(0,0,0,0))"*/
            });}, function(){
            $('.commentSecBack').css({
                "color": "rgba(100, 100, 100, 0.3)"/*,
                "background": "rgba(0, 0, 0, 0)"*/
            });}
        );
        $('.commentSecNext').css({
            "display": "block",
            "color": "rgba(100, 100, 100, 0.3)",
            "cursor": "pointer",
            "position": "absolute",
            "right": "0px",
            "height": "80px",
            "width": "50px", 
            "font-size": "3em",
            "line-height": "80px"
        }).hover(function(){
            $('.commentSecNext').css({
                "color": "rgba(255, 0, 0, 1)"/*,
                "background": "linear-gradient(to left, rgba(100,100,100,1), rgba(0,0,0,0))"*/
            });}, function(){
            $('.commentSecNext').css({
                "color": "rgba(100, 100, 100, 0.3)"/*,
                "background": "rgba(0, 0, 0, 0)"*/
            });}
        );
        $('.commentBackground').css({
            "display": "inline-block",
            "cursor": "pointer",
            "font-size": "20px",
            "color": "rgba(200, 200, 200, 1)",
            "background": "rgba(0, 70, 0, 1)",
            "border-radius": "5px",
            "width": "150px"
        }).hover(function(){
            $('.commentBackground').css({
                "color": "rgba(255, 0, 0, 1)",
                "background": "rgba(0,90,0,1)"
            });}, function(){
            $('.commentBackground').css({
                "color": "rgba(200, 200, 200, 1)",
                "background": "rgba(0, 70, 0, 1)",
                "border-radius": "5px"
            });}
        );
        $('.commentJump').css({
            "display": "inline-block",
            "cursor": "pointer",
            "color": "rgba(50, 50, 100, 1)"
        }).hover(function(){
            $(this).css({
                "color": "rgba(200, 0, 0, 1)",
                "text-decoration": "underline"
            });}, function(){
            $(this).css({
                "color": "rgba(50, 50, 100, 1)",
                "text-decoration": "none"
            });}
        );
        break;
      default:
        break;
    }
  },
  render:function(ps,dom){
    var that=this;
    switch(ps.titleId){
      case "fhlInfoParsing":
        var html="";
        var ajaxUrl=getAjaxUrl("qp",ps);
        $.ajax({
          url:ajaxUrl
        }).done(function(d,s,j){
          if(j){                  
            var jsonObj=JSON.parse(j.responseText);
            var v_name=jsonObj.v_name;
            var version=jsonObj.version;
            var prev_chineses=jsonObj.prev.chineses;
            var prev_engs=jsonObj.prev.engs;
            var prev_chap=jsonObj.prev.chap;
            var prev_sec=jsonObj.prev.sec;
            var next_chineses=jsonObj.next.chineses;
            var next_engs=jsonObj.next.engs;
            var next_chap=jsonObj.next.chap;
            var next_sec=jsonObj.next.sec;
            var proc=jsonObj.proc;
            var div_name=ps.titleId;
            if (version=="cbol") proc=10;//原文直譯
            var orig_font;
            var head_str="";
            var body_str="";
            var clrstr="";
            var clrcnt=0;
            var N=jsonObj.N;
            if (N==0) orig_font="g1";
            else    orig_font="g2";
            var html=jsonObj.N+"</br>";
            for (var i=0;i<jsonObj.record.length;i++){
                var wid=jsonObj.record[i].wid;
                var word=jsonObj.record[i].word;
                var exp=jsonObj.record[i].exp;
                var id=jsonObj.record[i].id;
                var parallel="";
                var align_str="";
                if (wid==0)
                {
                    
                    if (N==0)//NT
                    {
                        var wstr="";
                        var wd=word.split("+");
                        if (wd.length>0)
                        {
                            for (var ii=0;ii<wd.length;ii++)
                            {
                                if (ii%3==0)
                                    wstr=wstr+wd[ii];
                                else if (ii%3==1)
                                    wstr=wstr+"(韋："+wd[ii]+")";
                                else if (ii%3==2)
                                    wstr=wstr+"(聯："+wd[ii]+")";
                            }
                            word=wstr;
                            //console.log(word);
                        }
                    }
                    else if (N==1) //OT
                    {
                        var remark=jsonObj.record[i].remark;
                        var engs=jsonObj.record[i].engs;
                        if (remark.length>0)
                        {
                                parallel="平行經文："+remark;
                        }
                        align_str="align=\"right\" style=\"padding:0px 10px 0px 0px;\"";
                    }                    

                    var bookName=getBookFunc("bookFullName",ps.chineses);
                    if(bookName!="failed"){                      
                      if(ps.chineses==book[0]&&ps.chap==1&&ps.sec==1){
                        head_str+="";
                      }else{
                        head_str+="<span class='secBack' ";
                        head_str+="engs="+prev_engs+" chap="+prev_chap+" sec="+prev_sec;
                        head_str+=">&#x25C0</span>";
                      }      
                      head_str+="<span>"+bookName;
                      head_str+="&nbsp&nbsp"+ps.chap+":"+ps.sec+"</span>";
                      if(ps.chineses==book[65]&&ps.chap==22&&ps.sec==21){
                        head_str+="";
                      }else{
                        head_str+="<span class='secNext' ";
                        head_str+="engs="+next_engs+" chap="+next_chap+" sec="+next_sec;
                        head_str+=">&#x25B6</span>";
                      }
                    }                                        
                    /*
                    var poverhead="",noverhead="";                    
                    if (prev_chineses!=chineses||prev_chap!=chap)
                        poverhead=";Gclick=false;Gsec="+prev_sec+";read_bible('"+chineses+"',"+prev_chap+");";
                    if (next_chineses!=chineses||next_chap!=chap)
                        noverhead=";Gclick=false;Gsec="+next_sec+";read_bible('"+chineses+"',"+next_chap+");";
                        head_str="<span style=\"font-size:150%;\"><a href=\"javascript:spar('"+prev_engs+"',"+prev_chap+","+prev_sec+",'"+div_name+"')"+
                        poverhead+"\">&lt;</a> <span class=\"psn\">"+
                        chinesef+"  "+chap+":"+sec
                        +"</span> <a href=\"javascript:spar('"+next_engs+"',"+next_chap+","+next_sec+",'"+div_name+"')"+
                        noverhead+"\">&gt;</a></span> "+parallel+"<br/>";
                    */                   
                   var nword=word.split("\n");
                   var nexp=exp.split("\n");                                      
                   if (N==1){//OT                                 
                      var wid=1;                   
                      for (var ii=0;ii<nword.length;ii++){                                                
                        var t=nword[nword.length-ii-1].split(" ");
                        //console.dir(t);                                                
                        head_str+="<div>";
                        for (var iii=0;iii<t.length;iii++){                          
                          //console.log(t[iii]);
                          if(t[iii].indexOf("-")==-1){
                            var sn=jsonObj.record[wid].sn;
                            var wform=jsonObj.record[wid].wform;
                            var orig=jsonObj.record[wid].orig;
                            var remark=jsonObj.record[wid].remark;
                            var exp1=jsonObj.record[wid].exp;
                            var par=encodeURIComponent(wform+'|'+orig+'|'+exp1+'|'+remark+'|');
                            head_str+="<span class=parsing N=1 k="+sn+" par="+par+">";
                            head_str+=t[iii]+"&nbsp</span>";
                            wid++;
                          }else{
                            var s=t[iii].split("-");
                            for(iiii=0;iiii<s.length;iiii++){
                              var sn=jsonObj.record[wid].sn;
                              var wform=jsonObj.record[wid].wform;
                              var orig=jsonObj.record[wid].orig;
                              var remark=jsonObj.record[wid].remark;
                              var exp1=jsonObj.record[wid].exp;
                              var par=encodeURIComponent(wform+'|'+orig+'|'+exp1+'|'+remark+'|');
                              head_str+="<span class=parsing N=1 k="+sn+" par="+par+">";
                              if(iiii==0)
                                head_str+=s[iiii]+"-</span>";
                              else
                                head_str+=s[iiii]+"&nbsp</span>";
                              wid++;
                            }                            
                          }
                        }
                        head_str+="</div>";
                        head_str+="<div>"+nexp[ii]+"</div>";                        
                      }
                   }
                   else if (N==0){
                      var wid=1;
                      for (var ii=0;ii<nword.length;ii++){                                                
                        nword[ii]=nword[ii].trim();
                        var t=nword[ii].split(" ");
                        //console.dir(t);
                        head_str+="<div>";
                        for (var iii=0;iii<t.length;iii++,wid++){
                          var sn=jsonObj.record[wid].sn;
                          var pro=jsonObj.record[wid].pro;
                          var wform=jsonObj.record[wid].wform;
                          var orig=jsonObj.record[wid].orig;
                          var remark=jsonObj.record[wid].remark;
                          var exp1=jsonObj.record[wid].exp;
                          var par=encodeURIComponent(pro+'|'+wform+'|'+orig+'|'+exp1+'|'+remark+'|');
                          head_str+="<span class=parsing N=0 k="+sn+" par="+par+">";
                          head_str+=t[iii]+"&nbsp</span>";
                        }
                        head_str+="</div>";
                        head_str+="<div>"+nexp[ii]+"</div>";                        
                      }                          
                   }
             }
             else
            {
                if (N==0 && word=="+") {
                  /*
                    clrcnt=(clrcnt+1)%3;
                    if (clrcnt==0) clrstr="";
                    else if (clrcnt==1) clrstr="#ffff99";
                    else if (clrcnt==2) clrstr="#ffcccc";
                    msg=skip1tag(msg,"record");
                    */
                    continue;
                }
                var sn=jsonObj.record[i].sn;
                var pro=jsonObj.record[i].pro;
                var wform=jsonObj.record[i].wform;
                var orig=jsonObj.record[i].orig;
                var remark=jsonObj.record[i].remark;
                var pt=remark.indexOf("[#");
                var pt1=remark.indexOf("#]");
                while (N==1 && pt>=0 && pt1>pt)
                {
                    var nstr="";
                    var pstr=remark.substring(pt+2,pt1);
                    pstr=pstr.replace(/１/g,"1");
                    pstr=pstr.replace(/２/g,"2");
                    pstr=pstr.replace(/３/g,"3");
                    pstr=pstr.replace(/４/g,"4");
                    pstr=pstr.replace(/５/g,"5");
                    pstr=pstr.replace(/６/g,"6");
                    pstr=pstr.replace(/７/g,"7");
                    pstr=pstr.replace(/８/g,"8");
                    pstr=pstr.replace(/９/g,"9");
                    pstr=pstr.replace(/．/g,".");
                    subheb=pstr.split(",");
                    nstr="§";
                    for (si=0;si<subheb.length;si++)
                    {
                        subheb[si]=subheb[si].trim();
                        if (subheb[si].length==0) continue;
                        spt=subheb[si].split("-");
                        nstr=nstr+"<a href=\"/new/pimg/"+spt[0]+".png\" target=\"grammer\">"+subheb[si]+"</a> ";
                    }
                    remark=remark.substring(0,pt)+nstr+remark.substring(pt1+2);
                    pt=remark.indexOf("[#");
                    pt1=remark.indexOf("#]");
                }
                body_str=body_str+"<tr bgcolor=\""+clrstr+"\"><td class=\""+orig_font+"\">"+word+"</td><td class=\"g0\"><span class=\"parsingTable\" N="+N+" k="+sn+">"+sn+"</span></td><td class=\"g0\">";
                if (N==0)
                    body_str=body_str+pro+"</td><td class=\"g0\">";
                body_str=body_str+wform+"</td><td class=\""+orig_font+"\">"+orig+"</td><td class=\"g0\">"+exp+"</td><td class=\"g0\">"
                        +remark+"</td></tr>";
             }//else
            }//for I
             var ptg="";
             if (N==0)
                ptg="<td class=\"g0\">詞性</td>";
             var headDivStyle="<div style=\"height:25%;overflow:auto;"+((N==1)?"text-align:right;":"")+
                  "\">";

            dom.html(headDivStyle+head_str+"</div><div style=\"height:70%;overflow:auto;\"><hr/><table border=\"1\">"+"<tr><td class=\"g0\">原文字</td><td class=\"g0\">SN</td>"+ptg+"<td class=\"g0\">字彙分析</td><td class=\"g0\">原型</td><td class=\"g0\">原型簡義</td><td class=\"g0\">備註</td>"+body_str+"</table></div>");
            that.registerEvents(ps);
          }//if j
        });
        //tjm      
        break;
      case "fhlInfoComment":
        var html="";
        var ajaxUrl=getAjaxUrl("sc",ps);
        //console.log(ajaxUrl);
        $.ajax({
          url:ajaxUrl
        }).done(function(d,s,j){
          if(j){                  
            function parseComment(t){                    
              t=t.replace(/\n/g,"</br>");
              t=t.replace(/ /g,"&nbsp");
              var pt,pt1;
              var tok, tok_str;
              var span_str;
              var i=0;
              while(true){
                pt=t.indexOf("#");
                pt1=t.indexOf("|");
                if(pt<0||pt1<0||pt1<=pt)
                  break;
                tok_str=t.substring(pt+1,pt1);
                span_str="";

                while(tok_str.length!==0){
                    var firstTokEnd = tok_str.indexOf(";");
                    if(firstTokEnd===-1)
                        firstTokEnd = tok_str.length;
                    tok = tok_str.substring(0, firstTokEnd);
                    tok_str = tok_str.substring(firstTokEnd+1, tok_str.length);

                    span_str += "&nbsp;<span class='commentJump' engs=";
                    var secNumberEnd = tok.indexOf("-");
                    if(secNumberEnd === -1)
                        secNumberEnd = tok.length;
                    var chapNumberEnd = tok.indexOf(":");
                    var secNumber = tok.substring(chapNumberEnd+1, secNumberEnd);
                    if(!isNaN(tok[0])){ // parse 在同一卷書裡面跳的
                        var chapNumber = tok.substring(0, chapNumberEnd);
                        span_str += ps.engs;
                    }
                    else{ // parse 有中文字在前面的
                        var bookNameEnd = tok.indexOf("&nbsp");
                        var bookName = tok.substring(0, bookNameEnd);
                        var chapNumber = tok.substring(bookNameEnd+5, chapNumberEnd);//+5是因為&nbsp
                        span_str += bookEng[book.indexOf(bookName)];
                    }
                    span_str += " chap=" + chapNumber + " sec='" + secNumber + "'>"+tok+"</span>&nbsp;";
                }
                t=t.substring(0,pt)+span_str+t.substring(pt1+1);
              }
              return t;
            }
            var jsonObj=JSON.parse(j.responseText);
            var prev_engs;
            var prev_chap;
            var prev_sec;
            var next_engs;
            var next_chap;
            var next_sec;
            var head_str="";
            var control_str="";

            if(jsonObj.hasOwnProperty('prev')){
                prev_engs=jsonObj.prev.engs;
                prev_chap=jsonObj.prev.chap;
                prev_sec=jsonObj.prev.sec;
                control_str+="<div class='commentSecBack' ";
                control_str+="engs="+prev_engs+" chap="+prev_chap+" sec="+prev_sec;
                control_str+=">&#x276e;</div>";
            }
            
            if(jsonObj.hasOwnProperty('next')){
                next_engs=jsonObj.next.engs;
                next_chap=jsonObj.next.chap;
                next_sec=jsonObj.next.sec;
                control_str+="<div class='commentSecNext' ";
                control_str+="engs="+next_engs+" chap="+next_chap+" sec="+next_sec;
                control_str+=">&#x276f;</div>";
            }
            
            if(ps.chap!=0&&ps.sec!=0){
                head_str+="<div style='position: absolute; display: block; width: 100%; height: 80px; text-align: center; font-size: 1.3em; line-height: 50px; margin: 0px;'>";
                head_str+=control_str;
                head_str+= jsonObj.record[0].title;
                head_str+="<div style='display: block; line-height: 100%;'>"
                head_str+="<span class='commentBackground' ";
                head_str+="engs="+ps.engs+" chap="+0+" sec="+0;
                head_str+=">書卷背景</span></div>";
            }
            else{
                var idx=getBookFunc('indexByEngs',ps.engs);
                head_str+="<div style='display: block; text-align: center; font-size: 1.3em; line-height: 50px;'>" + bookFullName[idx] +"&nbsp;背景資料</div>";
            }
            
            head_str+="</div>";

            var html=jsonObj.record[0].com_text;
            html=parseComment(html);
            html="<div style='display: absolute; padding: 0px; top: 0px; bottom: 0px; overflow: auto;'>" + head_str + '<div id="commentContent" style="position: absolute; top: 80px; left: 10px; right: 10px; bottom: 0px; display: block;  overflow: auto; word-wrap: break-word; word-break: normal; ">' + html + "</div></div>";

              /*height:' + ($(window).height()-200) + 'px;*/
            dom.html(html);          
            that.registerEvents(ps);
          }
        });
        break;
      case "fhlInfoPreach":
        do_preach(ps, dom);    
        break;
      case "fhlInfoTsk":
        var html=ps.titleId;
        dom.html(html);      
        break;
      case "fhlInfoOb":
        var html=ps.titleId;
        dom.html(html);
        break;
      case "fhlInfoAudio":

        // 有聲聖經 snow 
        {
          var pfn_callback = function fn_after_set(ibook, ichap) {
            ps.chineses = book[idx];
            ps.chap = ichap + 1; //因為是0-based 與 1-based
            ps.sec = 1;
            bookSelect.render(pageState, bookSelect.dom);
            fhlLecture.render(pageState, fhlLecture.dom);
            fhlInfo.render(pageState);
          };
          var idx = getBookFunc("index", ps.chineses); // 0-based
          //ps.chap; // 1-based
          audiobible.g_audiobible.set_book_chap(idx, ps.chap - 1, dom[0]);
          audiobible.g_audiobible.m_pfn_after_set = pfn_callback;
        }
        
        break;                                        
    }
  }
};

function parseDic(text){    
    var ps=pageState;    
    text=text.replace(/(定義|自希伯來文|於|自|參|與|同義詞|和|見|from|and|See|see entry)(\s+)/g,
      function replacer(match,p1,offset,string){return p1;});
    text=text.replace(/ /g,"&nbsp;");
    text=text.replace(/(於|自|參|與|同義詞|和|見|from|and|See|see entry)(\d+)/g,
      function replacer(match,p1,p2,offset,string){
          return p1+"<span class='snParse' N="+ps.N+">"+p2+"</span>";});
    text=text.replace(/自希伯來文(\d+)/g,function replacer(match,p1,offset,string){
          return "自希伯來文<span class='snParse' N=1>"+p1+"</span>";});
    text=text.replace(/定義(\d+)/g,function replacer(match,p1,offset,string){
          return "定義<span class='snParse' N="+ps.N+">"+p1+"</span>";});
    text=text.replace(/#(.*?)\|/g,function replacer(match,p1,offset,string){
          return "<span class='searchBibleVerse'>"+p1+"</span>";});
    text=text.replace(/\r\n/g,"</br>");
    return text;
}

var parsingPopUp={
  init:function(ps,dom){
    this.dom=dom;
    this.dom.hide();
  },
  registerEvents:function(ps){
    var that=this;
    this.dom.mouseleave(function(){
      that.dom.hide();
      that.dom.css({
        'overflow':'hidden',
        'height': 'auto'
      });
    });
    this.dom.mousedown(function(e){
      if(e.which==3){
        that.dom.unbind('mouseleave');
      }
    });
    $('.snParse').click(function(){
      //var offset=parsingPopUp.dom.offset;
      ps.N=$(this).attr('N');
      ps.k=$(this).html();
      parsingPopUp.render(ps,parsingPopUp.dom,null);
    });
    $('.searchBibleVerse').click(function(){
      var searchText=$(this).html();    
      searchText=searchText.replace(/&nbsp;/g," ");
      doSearch("#"+searchText+"|","search",0);
    });
    $('.searchSN').click(function(){
      doSearch($(this).attr('k'),"search",parseInt($(this).attr('N'))+1);
    });    
  },
  render:function(ps,dom,offset,par){
    var that=this;    
    if(par=="psn"){
      var ajaxUrl=getAjaxUrl('sd',ps);
      $.ajax({
        url:ajaxUrl
      }).done(function(d,s,j){      
        var jsonObj=JSON.parse(j.responseText);      
        var html=jsonObj.record[0].dic_text;
        html=parseDic(html);
        dom.html(html);
        if(offset!=null){
          var lecTop=164;
          var lecTopOffset=120;
          var RightWinH=$('#fhlInfo').height();
          var domH=dom.height();
        //console.log("top:"+offset.top+",domH:"+domH+",RightWinH:"+RightWinH);

          if(domH>RightWinH){
            //set css to auto scroll
          }else if(offset.top+domH>RightWinH){
            offset.top-=(offset.top>domH)?domH:offset.top;
            offset.left+=70;
          }              
          that.dom.show();
          dom.offset(offset);
        }        
        that.registerEvents(ps);
      });            
    }else if(par!=null){      
      var html=par;      
      dom.html(html);                  
      that.dom.show();
      if(offset!=null){
        dom.offset(offset);
      }
      //that.dom.scrollTop(0);      
      that.registerEvents(ps);
    }else{
      var ajaxUrl=getAjaxUrl('sd',ps);
      $.ajax({
        url:ajaxUrl
      }).done(function(d,s,j){      
        var jsonObj=JSON.parse(j.responseText);      
        var title="<span class='searchSN' N="+jsonObj.record[0].dic_type+" k="+
                jsonObj.record[0].sn+">";
        title+="出現經文</span></br>";
        var html=jsonObj.record[0].dic_text;
        html=parseDic(html);
        html=title+html;
        dom.html(html);                  
        var lecTop=164;
        var lecTopOffset=120;
        var leftWinH=$('#fhlMidWindow').height();
        var lecH=$('#fhlLecture').height();
        var scrollY=$('#fhlLecture').scrollTop();
        var scrollH=$('#fhlLecture')[0].scrollHeight;
        var domH=dom.height();
        //console.log("top:"+offset.top+",domH:"+domH+",leftWinH:"+leftWinH+",lecH:"+lecH);
        //console.log("scrollH:"+scrollH+",scrollY:"+scrollY);        
        if(offset != null){
          if(domH>leftWinH){
            //set css to auto scroll            
          }else if(offset.top+domH>leftWinH){
            offset.top-=(offset.top>domH)?domH:offset.top;
            offset.left+=50;
          }
  /*
          if((offset.top+domH+scrollY)>scrollH){

          }
          else if((offset.top+domH)>leftWinH){
            $('#fhlLecture').scrollTop(scrollY+offset.top-lecTop);
            offset.top-=offset.top-lecTop;
          }
  */
          that.dom.show();
          dom.offset(offset);          
        }
        that.registerEvents(ps);
      });
    }
  }
};
/***** End of fhlInfo *****/
</script>
  <!--Start of 搜尋功能-->
  <script src="search_api/fhl_api.js"></script>
  <script src="search_api/abvphp_api.js"></script>
  <link href="search_api/sephp_c_param.css" rel="stylesheet" />
  <script src="search_api/sephp_c_param.js"></script>
  <script src="preach_api/c_preach_frame.js"></script>
  <script>
    var fhl = fhl || {};
    var abvphp = abvphp || {};
    var sephp = sephp || {};

    var searchTool={
        init:function(ps,dom){
          this.dom=dom;
          this.render(ps,this.dom);
        },
        registerEvents:function(ps){
          var that=this;
            
          var $searchTrigger = $('[data-ic-class="search-trigger"]'),
            $searchInput = $('[data-ic-class="search-input"]'),
            $searchClear = $('[data-ic-class="search-clear"]');

          $searchTrigger.click(function() {
            var $this = $('[data-ic-class="search-trigger"]');
            $this.addClass('active');
            $searchInput.focus();
          });

          $searchInput.blur(function() {
            if ($searchInput.val().length > 0) {
              return false;
            } else {
              $searchTrigger.removeClass('active');
            }
          });

          $searchClear.click(function() {
            $searchInput.val('');
          });

          $searchInput.focus(function() {
            $searchTrigger.addClass('active');
          });

          $('.searchBtn').click(function(){
            ps.leftBtmWinShow=true;
            setPageState(ps);
            fhlMidBottomWindow.render(ps,fhlMidBottomWindow.dom);
            doSearch($('.searchBox').val(),"search",0);
            $searchInput.val('');
            $searchTrigger.removeClass('active');
          });
        },
        render:function(ps,dom){
          var html="";/*&#x1f50d;*/
            html+=' <div class="wrapper">\
                      <div class="icon-search-container" data-ic-class="search-trigger">\
                        <span class="search">⚲</span>\
                        <input type="text" class="searchBox search-input" data-ic-class="search-input" placeholder="Search" on/>\
                        <span class="times-circle" data-ic-class="search-clear">×</span>\
                      </div>\
                      <span class="searchBtn">快速搜尋</span>\
                    </div>'
          dom.html(html);
        }
    };
  </script>

  <!--講道功能 2015.05.11-->
  <script>
    function do_preach(ps,dom)
    {
      // 設定 callback function (scphp.set會呼叫)
      scphp.pfn_set_after = function pfn_set_after(rediv) {
        dom.html(rediv);

        // 四個樣式可設定 (可變更...現在只是隨便設)
        //for (var idx in scphp.divbooknames)//主題
        //  $(scphp.divbooknames[idx]).addClass("search_type");
        //for (var idx in scphp.divtitles)//範圍
        //  $(scphp.divtitles[idx]).addClass("search_type");
        for (var idx in scphp.divnexts)//範圍
          $(scphp.divnexts[idx]).addClass("search_type");
        for (var idx in scphp.divprevs)//範圍
          $(scphp.divprevs[idx]).addClass("search_type");
      }; // 設定 callback function (scphp.set會呼叫)

      // 設定 callback function (onclick時會呼叫)
      scphp.pfn_goto_sec = function pfn_(engs, chap, sec) {
        var idx = getBookFunc("indexByEngs", engs);
        ps.chineses = book[idx];
        ps.engs = engs;
        ps.chap = chap;
        ps.sec = sec;
        bookSelect.render(pageState, bookSelect.dom);
        fhlLecture.render(pageState, fhlLecture.dom);
        fhlInfo.render(pageState);
      }; // 設定 callback function (onclick時會呼叫)

      scphp.set(ps.engs, ps.chap, ps.sec);
    }//do_preach
  </script><!--講道功能 2015.05.11-->

  <script>
  function searchInit(ps){    
    var version="unv";
    
    abvphp.init_g_bibleversions();//必須先呼叫
    sephp.g_param.m_divDst = document.getElementById("fhlMidBottomWindowContent");

    sephp.g_param.mp_chineses = book;
    sephp.g_param.mp_vversion = version;    
    sephp.g_param.mpfn_search_title_change = function (msg) {
      document.getElementById("fhlMidBottomWindowTitle").innerHTML = "▽" + msg;
      ps.searchTitleMsg = msg;
    };// mpfn_search_title_change function pointer

    sephp.g_param.mpfn_read_bible = function (arg1_chinese, arg2_chap, arg3_sec) {
      //console.debug("mpfn_read_bible 參數");

      var idx = getBookFunc("index", arg1_chinese);
      ps.chineses = book[idx];
      ps.engs = bookEng[idx];
      ps.chap = arg2_chap;
      ps.sec = arg3_sec;
      setPageState(ps);
      bookSelect.render(pageState, bookSelect.dom);
      fhlLecture.render(pageState, fhlLecture.dom);
      fhlInfo.render(pageState);
    };// mpfn_read_bible function pointer

    sephp.g_param.initial_div_ui();//初始化
    if (pageState.gb == 0)
      sephp.g_param.m_isBig5 = true;
    else
      sephp.g_param.m_isBig5 = false;    

  }
  function doSearch(keyword,func,type){    
    sephp.g_param.m_keyword = keyword;
    sephp.g_param.m_userInputType = type;

    if(func=="search"){
      sephp.g_param.do_search();
    }
  }
  </script>
  <!--End of 搜尋功能-->
</head>
<body>
<!-- Layer 1-->
    
<nav id="fhlTopMenu">
    <img id="logoFHL" src="./images/logoTopMenuFHL.png"/>
    <ul class="menu">
        <li><a href="#"><span>讀經</span></a>
            <ul class="menu-hover">
                <li><a href="#"> 讀經介面(new)</a></li>
                <li><a href="#"> 閱讀計劃</a></li>
                <li><a href="#"> 讀經計劃表</a></li>
                <li><a href="#"> 主題研經</a></li>
                <li><a href="#"> 專卷研經</a></li>
            </ul>
        </li>
        <li><a href="#"><span>教學</span></a>
            <ul class="menu-hover">
                <li><a href="#"> 原文解經(new)</a></li>
                <li><a href="#"> 希伯來文朗讀</a></li>
                <li><a href="#"> 希臘文朗讀</a></li>
                <li><a href="#"> 希伯來文歌</a></li>
                <li><a href="#"> 中國教會史</a></li>
                <li><a href="#"> 聖經課程</a></li>
                <li><a href="#"> 多媒體教學</a></li>
            </ul>
        </li>
        <li><a href="#"><span>查詢</span></a>
            <ul class="menu-hover">
                <li><a href="#"> 主題查詢</a></li>
                <li><a href="#"> 經文查詢</a></li>
                <li><a href="#"> 物件地理查詢</a></li>
                <li><a href="#"> 教會查詢</a></li>
                <li><a href="#"> 其他查詢</a></li>
                <li><a href="#"> 聖詩查詢</a></li>
            </ul>
        </li>
        <li><a href="#"><span>工具</span></a>
            <ul class="menu-hover">
                <li><a href="#"> 舊約字彙分析</a></li>
                <li><a href="#"> 新約字彙分析</a></li>
                <li><a href="#"> 度量衡</a></li>
                <li><a href="#"> 簡寫對照</a></li>
                <li><a href="#"> 文法對照</a></li>
            </ul>
        </li>
        <li><a href="#"><span>專欄</span></a>
            <ul class="menu-hover">
                <li><a href="#"> 電子報</a></li>
                <li><a href="#"> 歷史走廊</a></li>
                <li><a href="#"> 英雄本色</a></li>
                <li><a href="#"> 經文鑑別</a></li>
                <li><a href="#"> 信望愛論壇</a></li>
                <li><a href="#"> 神學與生活</a></li>
                <li><a href="#"> 主日學教育</a></li>
                <li><a href="#"> 網路作家</a></li>
                <li><a href="#"> 靈糧選集</a></li>
            </ul>
        </li>
        <li><a href="#"><span>連結</span></a>
            <ul class="menu-hover">
                <li><a href="#"> 信望愛WWW</a></li>
                <li><a href="#"> 聖經資源</a></li>
                <li><a href="#"> 台語信望愛</a></li>
                <li><a href="#"> 客語信望愛</a></li>
                <li><a href="#"> 盲人點字</a></li>
                <li><a href="#"> 神學圖書</a></li>
                <li><a href="#"> 圖片資源</a></li>
                <li><a href="#"> 音樂網</a></li>
            </ul>
        </li>
        <li><a href="#"><span>義工</span></a>
            <ul class="menu-hover">
                <li><a href="#"> 公告</a></li>
                <li><a href="#"> 關於我們</a></li>
                <li><a href="#"> COBS工作區</a></li>
                <li><a href="#"> 義工群</a></li>
                <li><a href="#"> 徵稿</a></li>
                <li><a href="#"> 捐款</a></li>
                <li><a href="#"> 刊登消息</a></li>
                <li><a href="#"> 流量</a></li>
            </ul>
        </li>
    </ul>
</nav>
<div id="fhlToolBar">
    <div id="windowControl"></div>
    <div id="help"></div>
    <div id="bookSelect"></div>
    <div id="searchTool" class="smallText"></div>
</div>
<div id="fhlLeftWindow" class="leftWindow">
    <div class="leftWindowInside">
        <div id="settings">
            <div class="secondLevelInside">
                <p>&#9660;&nbsp;設定</p>
                <div>
                    <ul>
                        <li><div id="snSelect"></div></li>
                        <li><div id="realTimePopUpSelect"></div></li>
                        <li><div id="gbSelect"></div></li>
                        <li><div id="mapTool"></div></li>
                        <li><div id="imageTool"></div></li>
                        <li><div id="fontSizeTool"></div></li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="versionSelect"></div>
        <div id="viewHistory"></div>
    </div>
</div>
<div id="fhlMidWindow">
    <div id="fhlLecture"></div>
    <div id="fhlMidBottomWindow">
      <div id="fhlMidBottomWindowTitle"></div>
      <div id="fhlMidBottomWindowContent">
      </div>
    </div>
</div>
<div id="fhlInfo">
  <div id="fhlInfoTitle"></div>
  <div id="fhlInfoContent"></div>
</div>
<!-- Layer 2 windows that hide after mouse leave-->
<div id="bookSelectPopUp">
  <div id="bookSelectName"></div>
  <div id="bookSelectChapter"></div>
</div>
<div id="parsingPopUp"></div>
<div id="helpingPopUp"><div id="helpingPopUpInside"></div></div>
<!-- Layer 3 windows that exists after mouse leave-->
<div id="dictionaryPopUp"></div>
</body>
</html>